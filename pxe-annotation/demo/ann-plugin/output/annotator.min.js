"use strict";!function(){var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};!function(b){function c(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},d=Object.create(a.prototype);for(var e in c)d[e]=c[e];return d.constructor=b,b.prototype=d,b}function d(a){a=a||{},this.defaultProtocol=a.defaultProtocol||m.defaultProtocol,this.events=a.events||m.events,this.format=a.format||m.format,this.formatHref=a.formatHref||m.formatHref,this.nl2br=a.nl2br||m.nl2br,this.tagName=a.tagName||m.tagName,this.target=a.target||m.target,this.validate=a.validate||m.validate,this.ignoreTags=[],this.attributes=a.attributes||a.linkAttributes||m.attributes,this.className=a.className||a.linkClass||m.className;for(var b=a.ignoreTags||m.ignoreTags,c=0;c<b.length;c++)this.ignoreTags.push(b[c].toUpperCase())}function e(a,b){for(var c=0;c<a.length;c++)if(a[c]===b)return!0;return!1}function f(a){return a}function g(a,b){return"url"===b?"_blank":null}function h(){return function(a){this.j=[],this.T=a||null}}function i(a,b,c,d){for(var e=0,f=a.length,g=b,h=[],i=void 0;e<f&&(i=g.next(a[e]));)g=i,e++;if(e>=f)return[];for(;e<f-1;)i=new p(d),h.push(i),g.on(a[e],i),g=i,e++;return i=new p(c),h.push(i),g.on(a[f-1],i),h}function j(){return function(a){a&&(this.v=a)}}function k(a){var b=a?{v:a}:{};return c(r,j(),b)}function l(a){return a instanceof s||a instanceof I}var m={defaultProtocol:"http",events:null,format:f,formatHref:f,nl2br:!1,tagName:"a",target:g,validate:!0,ignoreTags:[],attributes:null,className:"linkified"};d.prototype={resolve:function(a){var b=a.toHref(this.defaultProtocol);return{formatted:this.get("format",a.toString(),a),formattedHref:this.get("formatHref",b,a),tagName:this.get("tagName",b,a),className:this.get("className",b,a),target:this.get("target",b,a),events:this.getObject("events",b,a),attributes:this.getObject("attributes",b,a)}},check:function(a){return this.get("validate",a.toString(),a)},get:function(b,c,d){var e=this[b];if(!e)return e;switch(void 0===e?"undefined":a(e)){case"function":return e(c,d.type);case"object":var f=e[d.type]||m[b];return"function"==typeof f?f(c,d.type):f}return e},getObject:function(a,b,c){var d=this[a];return"function"==typeof d?d(b,c.type):d}};var n=Object.freeze({defaults:m,Options:d,contains:e}),o=h();o.prototype={defaultTransition:!1,on:function(a,b){if(a instanceof Array){for(var c=0;c<a.length;c++)this.j.push([a[c],b]);return this}return this.j.push([a,b]),this},next:function(a){for(var b=0;b<this.j.length;b++){var c=this.j[b],d=c[0],e=c[1];if(this.test(a,d))return e}return this.defaultTransition},accepts:function(){return!!this.T},test:function(a,b){return a===b},emit:function(){return this.T}};var p=c(o,h(),{test:function(a,b){return a===b||b instanceof RegExp&&b.test(a)}}),q=c(o,h(),{jump:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,c=this.next(new a(""));return c===this.defaultTransition?(c=new this.constructor(b),this.on(a,c)):b&&(c.T=b),c},test:function(a,b){return a instanceof b}}),r=j();r.prototype={toString:function(){return this.v+""}};var s=k(),t=k("@"),u=k(":"),v=k("."),w=k(),x=k(),y=k("\n"),z=k(),A=k("+"),B=k("#"),C=k(),D=k("mailto:"),E=k("?"),F=k("/"),G=k("_"),H=k(),I=k(),J=k(),K=k("{"),L=k("["),M=k("<"),N=k("("),O=k("}"),P=k("]"),Q=k(">"),R=k(")"),S=k("&"),T=Object.freeze({Base:r,DOMAIN:s,AT:t,COLON:u,DOT:v,PUNCTUATION:w,LOCALHOST:x,NL:y,NUM:z,PLUS:A,POUND:B,QUERY:E,PROTOCOL:C,MAILTO:D,SLASH:F,UNDERSCORE:G,SYM:H,TLD:I,WS:J,OPENBRACE:K,OPENBRACKET:L,OPENANGLEBRACKET:M,OPENPAREN:N,CLOSEBRACE:O,CLOSEBRACKET:P,CLOSEANGLEBRACKET:Q,CLOSEPAREN:R,AMPERSAND:S}),U="aaa|aarp|abb|abbott|abogado|ac|academy|accenture|accountant|accountants|aco|active|actor|ad|adac|ads|adult|ae|aeg|aero|af|afl|ag|agency|ai|aig|airforce|airtel|al|alibaba|alipay|allfinanz|alsace|am|amica|amsterdam|an|analytics|android|ao|apartments|app|apple|aq|aquarelle|ar|aramco|archi|army|arpa|arte|as|asia|associates|at|attorney|au|auction|audi|audio|author|auto|autos|avianca|aw|ax|axa|az|azure|ba|baidu|band|bank|bar|barcelona|barclaycard|barclays|bargains|bauhaus|bayern|bb|bbc|bbva|bcg|bcn|bd|be|beats|beer|bentley|berlin|best|bet|bf|bg|bh|bharti|bi|bible|bid|bike|bing|bingo|bio|biz|bj|black|blackfriday|bloomberg|blue|bm|bms|bmw|bn|bnl|bnpparibas|bo|boats|boehringer|bom|bond|boo|book|boots|bosch|bostik|bot|boutique|br|bradesco|bridgestone|broadway|broker|brother|brussels|bs|bt|budapest|bugatti|build|builders|business|buy|buzz|bv|bw|by|bz|bzh|ca|cab|cafe|cal|call|camera|camp|cancerresearch|canon|capetown|capital|car|caravan|cards|care|career|careers|cars|cartier|casa|cash|casino|cat|catering|cba|cbn|cc|cd|ceb|center|ceo|cern|cf|cfa|cfd|cg|ch|chanel|channel|chase|chat|cheap|chloe|christmas|chrome|church|ci|cipriani|circle|cisco|citic|city|cityeats|ck|cl|claims|cleaning|click|clinic|clinique|clothing|cloud|club|clubmed|cm|cn|co|coach|codes|coffee|college|cologne|com|commbank|community|company|compare|computer|comsec|condos|construction|consulting|contact|contractors|cooking|cool|coop|corsica|country|coupon|coupons|courses|cr|credit|creditcard|creditunion|cricket|crown|crs|cruises|csc|cu|cuisinella|cv|cw|cx|cy|cymru|cyou|cz|dabur|dad|dance|date|dating|datsun|day|dclk|de|dealer|deals|degree|delivery|dell|deloitte|delta|democrat|dental|dentist|desi|design|dev|diamonds|diet|digital|direct|directory|discount|dj|dk|dm|dnp|do|docs|dog|doha|domains|download|drive|dubai|durban|dvag|dz|earth|eat|ec|edeka|edu|education|ee|eg|email|emerck|energy|engineer|engineering|enterprises|epson|equipment|er|erni|es|esq|estate|et|eu|eurovision|eus|events|everbank|exchange|expert|exposed|express|fage|fail|fairwinds|faith|family|fan|fans|farm|fashion|fast|feedback|ferrero|fi|film|final|finance|financial|firestone|firmdale|fish|fishing|fit|fitness|fj|fk|flickr|flights|florist|flowers|flsmidth|fly|fm|fo|foo|football|ford|forex|forsale|forum|foundation|fox|fr|fresenius|frl|frogans|frontier|fund|furniture|futbol|fyi|ga|gal|gallery|gallup|game|garden|gb|gbiz|gd|gdn|ge|gea|gent|genting|gf|gg|ggee|gh|gi|gift|gifts|gives|giving|gl|glass|gle|global|globo|gm|gmail|gmbh|gmo|gmx|gn|gold|goldpoint|golf|goo|goog|google|gop|got|gov|gp|gq|gr|grainger|graphics|gratis|green|gripe|group|gs|gt|gu|gucci|guge|guide|guitars|guru|gw|gy|hamburg|hangout|haus|hdfcbank|health|healthcare|help|helsinki|here|hermes|hiphop|hitachi|hiv|hk|hm|hn|hockey|holdings|holiday|homedepot|homes|honda|horse|host|hosting|hoteles|hotmail|house|how|hr|hsbc|ht|hu|hyundai|ibm|icbc|ice|icu|id|ie|ifm|iinet|il|im|immo|immobilien|in|industries|infiniti|info|ing|ink|institute|insurance|insure|int|international|investments|io|ipiranga|iq|ir|irish|is|iselect|ist|istanbul|it|itau|iwc|jaguar|java|jcb|je|jetzt|jewelry|jlc|jll|jm|jmp|jo|jobs|joburg|jot|joy|jp|jpmorgan|jprs|juegos|kaufen|kddi|ke|kerryhotels|kerrylogistics|kerryproperties|kfh|kg|kh|ki|kia|kim|kinder|kitchen|kiwi|km|kn|koeln|komatsu|kp|kpn|kr|krd|kred|kuokgroup|kw|ky|kyoto|kz|la|lacaixa|lamborghini|lamer|lancaster|land|landrover|lanxess|lasalle|lat|latrobe|law|lawyer|lb|lc|lds|lease|leclerc|legal|lexus|lgbt|li|liaison|lidl|life|lifeinsurance|lifestyle|lighting|like|limited|limo|lincoln|linde|link|live|living|lixil|lk|loan|loans|local|locus|lol|london|lotte|lotto|love|lr|ls|lt|ltd|ltda|lu|lupin|luxe|luxury|lv|ly|ma|madrid|maif|maison|makeup|man|management|mango|market|marketing|markets|marriott|mba|mc|md|me|med|media|meet|melbourne|meme|memorial|men|menu|meo|mg|mh|miami|microsoft|mil|mini|mk|ml|mm|mma|mn|mo|mobi|mobily|moda|moe|moi|mom|monash|money|montblanc|mormon|mortgage|moscow|motorcycles|mov|movie|movistar|mp|mq|mr|ms|mt|mtn|mtpc|mtr|mu|museum|mutuelle|mv|mw|mx|my|mz|na|nadex|nagoya|name|natura|navy|nc|ne|nec|net|netbank|network|neustar|new|news|nexus|nf|ng|ngo|nhk|ni|nico|nikon|ninja|nissan|nl|no|nokia|norton|nowruz|np|nr|nra|nrw|ntt|nu|nyc|nz|obi|office|okinawa|om|omega|one|ong|onl|online|ooo|oracle|orange|org|organic|origins|osaka|otsuka|ovh|pa|page|pamperedchef|panerai|paris|pars|partners|parts|party|passagens|pe|pet|pf|pg|ph|pharmacy|philips|photo|photography|photos|physio|piaget|pics|pictet|pictures|pid|pin|ping|pink|pizza|pk|pl|place|play|playstation|plumbing|plus|pm|pn|pohl|poker|porn|post|pr|praxi|press|pro|prod|productions|prof|promo|properties|property|protection|ps|pt|pub|pw|pwc|py|qa|qpon|quebec|quest|racing|re|read|realtor|realty|recipes|red|redstone|redumbrella|rehab|reise|reisen|reit|ren|rent|rentals|repair|report|republican|rest|restaurant|review|reviews|rexroth|rich|ricoh|rio|rip|ro|rocher|rocks|rodeo|room|rs|rsvp|ru|ruhr|run|rw|rwe|ryukyu|sa|saarland|safe|safety|sakura|sale|salon|samsung|sandvik|sandvikcoromant|sanofi|sap|sapo|sarl|sas|saxo|sb|sbs|sc|sca|scb|schaeffler|schmidt|scholarships|school|schule|schwarz|science|scor|scot|sd|se|seat|security|seek|select|sener|services|seven|sew|sex|sexy|sfr|sg|sh|sharp|shell|shia|shiksha|shoes|show|shriram|si|singles|site|sj|sk|ski|skin|sky|skype|sl|sm|smile|sn|sncf|so|soccer|social|softbank|software|sohu|solar|solutions|song|sony|soy|space|spiegel|spot|spreadbetting|sr|srl|st|stada|star|starhub|statefarm|statoil|stc|stcgroup|stockholm|storage|store|studio|study|style|su|sucks|supplies|supply|support|surf|surgery|suzuki|sv|swatch|swiss|sx|sy|sydney|symantec|systems|sz|tab|taipei|taobao|tatamotors|tatar|tattoo|tax|taxi|tc|tci|td|team|tech|technology|tel|telecity|telefonica|temasek|tennis|tf|tg|th|thd|theater|theatre|tickets|tienda|tiffany|tips|tires|tirol|tj|tk|tl|tm|tmall|tn|to|today|tokyo|tools|top|toray|toshiba|total|tours|town|toyota|toys|tp|tr|trade|trading|training|travel|travelers|travelersinsurance|trust|trv|tt|tube|tui|tunes|tushu|tv|tvs|tw|tz|ua|ubs|ug|uk|unicom|university|uno|uol|us|uy|uz|va|vacations|vana|vc|ve|vegas|ventures|verisign|versicherung|vet|vg|vi|viajes|video|viking|villas|vin|vip|virgin|vision|vista|vistaprint|viva|vlaanderen|vn|vodka|volkswagen|vote|voting|voto|voyage|vu|vuelos|wales|walter|wang|wanggou|watch|watches|weather|weatherchannel|webcam|weber|website|wed|wedding|weir|wf|whoswho|wien|wiki|williamhill|win|windows|wine|wme|wolterskluwer|work|works|world|ws|wtc|wtf|xbox|xerox|xin|xperia|xxx|xyz|yachts|yahoo|yamaxun|yandex|ye|yodobashi|yoga|yokohama|youtube|yt|za|zara|zero|zip|zm|zone|zuerich|zw".split("|"),V="0123456789".split(""),W="0123456789abcdefghijklmnopqrstuvwxyz".split(""),X=[" ","\f","\r","\t","\v"," "," ","᠎"],Y=[],Z=function(a){return new p(a)},$=Z(),_=Z(z),aa=Z(s),ba=Z(),ca=Z(J);$.on("@",Z(t)).on(".",Z(v)).on("+",Z(A)).on("#",Z(B)).on("?",Z(E)).on("/",Z(F)).on("_",Z(G)).on(":",Z(u)).on("{",Z(K)).on("[",Z(L)).on("<",Z(M)).on("(",Z(N)).on("}",Z(O)).on("]",Z(P)).on(">",Z(Q)).on(")",Z(R)).on("&",Z(S)).on([",",";","!",'"',"'"],Z(w)),$.on("\n",Z(y)).on(X,ca),ca.on(X,ca);for(var da=0;da<U.length;da++){var ea=i(U[da],$,I,s);Y.push.apply(Y,ea)}var fa=i("file",$,s,s),ga=i("ftp",$,s,s),ha=i("http",$,s,s),ia=i("mailto",$,s,s);Y.push.apply(Y,fa),Y.push.apply(Y,ga),Y.push.apply(Y,ha);var ja=fa.pop(),ka=ga.pop(),la=ha.pop(),ma=ia.pop(),na=Z(s),oa=Z(C),pa=Z(D);ka.on("s",na).on(":",oa),la.on("s",na).on(":",oa),Y.push(na),ja.on(":",oa),na.on(":",oa),ma.on(":",pa);var qa=i("localhost",$,x,s);Y.push.apply(Y,qa),$.on(V,_),_.on("-",ba).on(V,_).on(W,aa),aa.on("-",ba).on(W,aa);for(var ra=0;ra<Y.length;ra++)Y[ra].on("-",ba).on(W,aa);ba.on("-",ba).on(V,aa).on(W,aa),$.defaultTransition=Z(H);var sa=function(a){for(var b=a.replace(/[A-Z]/g,function(a){return a.toLowerCase()}),c=a.length,d=[],e=0;e<c;){for(var f=$,g=null,h=0,i=null,j=-1;e<c&&(g=f.next(b[e]));)null,f=g,f.accepts()?(j=0,i=f):j>=0&&j++,h++,e++;if(!(j<0)){e-=j,h-=j;var k=i.emit();d.push(new k(a.substr(e-h,h)))}}return d},ta=$,ua=Object.freeze({State:p,TOKENS:T,run:sa,start:ta}),va=j();va.prototype={type:"token",isLink:!1,toString:function(){for(var a=[],b=0;b<this.v.length;b++)a.push(this.v[b].toString());return a.join("")},toHref:function(){return this.toString()},toObject:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"http";return{type:this.type,value:this.toString(),href:this.toHref(a)}}};var wa=c(va,j(),{type:"email",isLink:!0}),xa=c(va,j(),{type:"email",isLink:!0,toHref:function(){this.v;return"mailto:"+this.toString()}}),ya=c(va,j(),{type:"text"}),za=c(va,j(),{type:"nl"}),Aa=c(va,j(),{type:"url",isLink:!0,toHref:function(){for(var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"http",b=!1,c=!1,d=this.v,e=[],f=0;d[f]instanceof C;)b=!0,e.push(d[f].toString().toLowerCase()),f++;for(;d[f]instanceof F;)c=!0,e.push(d[f].toString()),f++;for(;l(d[f]);)e.push(d[f].toString().toLowerCase()),f++;for(;f<d.length;f++)e.push(d[f].toString());return e=e.join(""),b||c||(e=a+"://"+e),e},hasProtocol:function(){return this.v[0]instanceof C}}),Ba=Object.freeze({Base:va,MAILTOEMAIL:wa,EMAIL:xa,NL:za,TEXT:ya,URL:Aa}),Ca=function(a){return new q(a)},Da=Ca(),Ea=Ca(),Fa=Ca(),Ga=Ca(),Ha=Ca(),Ia=Ca(),Ja=Ca(),Ka=Ca(Aa),La=Ca(),Ma=Ca(Aa),Na=Ca(Aa),Oa=Ca(),Pa=Ca(),Qa=Ca(),Ra=Ca(),Sa=Ca(),Ta=Ca(Aa),Ua=Ca(Aa),Va=Ca(Aa),Wa=Ca(Aa),Xa=Ca(),Ya=Ca(),Za=Ca(),$a=Ca(),_a=Ca(),ab=Ca(),bb=Ca(xa),cb=Ca(),db=Ca(xa),eb=Ca(wa),fb=Ca(),gb=Ca(),hb=Ca(),ib=Ca(),jb=Ca(za);Da.on(y,jb).on(C,Ea).on(D,Fa).on(F,Ga),Ea.on(F,Ga),Ga.on(F,Ha),Da.on(I,Ia).on(s,Ia).on(x,Ka).on(z,Ia),Ha.on(I,Na).on(s,Na).on(z,Na).on(x,Na),Ia.on(v,Ja),_a.on(v,ab),Ja.on(I,Ka).on(s,Ia).on(z,Ia).on(x,Ia),ab.on(I,bb).on(s,_a).on(z,_a).on(x,_a),Ka.on(v,Ja),bb.on(v,ab),Ka.on(u,La).on(F,Na),La.on(z,Ma),Ma.on(F,Na),bb.on(u,cb),cb.on(z,db);var kb=[s,t,x,z,A,B,C,F,I,G,H,S],lb=[u,v,E,w,O,P,Q,R,K,L,M,N];Na.on(K,Pa).on(L,Qa).on(M,Ra).on(N,Sa),Oa.on(K,Pa).on(L,Qa).on(M,Ra).on(N,Sa),Pa.on(O,Na),Qa.on(P,Na),Ra.on(Q,Na),Sa.on(R,Na),Ta.on(O,Na),Ua.on(P,Na),Va.on(Q,Na),Wa.on(R,Na),Xa.on(O,Na),Ya.on(P,Na),Za.on(Q,Na),$a.on(R,Na),Pa.on(kb,Ta),Qa.on(kb,Ua),Ra.on(kb,Va),Sa.on(kb,Wa),Pa.on(lb,Xa),Qa.on(lb,Ya),Ra.on(lb,Za),Sa.on(lb,$a),Ta.on(kb,Ta),Ua.on(kb,Ua),Va.on(kb,Va),Wa.on(kb,Wa),Ta.on(lb,Ta),Ua.on(lb,Ua),Va.on(lb,Va),Wa.on(lb,Wa),Xa.on(kb,Ta),Ya.on(kb,Ua),Za.on(kb,Va),$a.on(kb,Wa),Xa.on(lb,Xa),Ya.on(lb,Ya),Za.on(lb,Za),$a.on(lb,$a),Na.on(kb,Na),Oa.on(kb,Na),Na.on(lb,Oa),Oa.on(lb,Oa),Fa.on(I,eb).on(s,eb).on(z,eb).on(x,eb),eb.on(kb,eb).on(lb,fb),fb.on(kb,eb).on(lb,fb);var mb=[s,z,A,B,E,G,H,S,I];Ia.on(mb,gb).on(t,hb),Ka.on(mb,gb).on(t,hb),Ja.on(mb,gb),gb.on(mb,gb).on(t,hb).on(v,ib),ib.on(mb,gb),hb.on(I,_a).on(s,_a).on(x,bb);var nb=function(a){for(var b=a.length,c=0,d=[],e=[];c<b;){for(var f=Da,g=null,h=null,i=0,j=null,k=-1;c<b&&!(g=f.next(a[c]));)e.push(a[c++]);for(;c<b&&(h=g||f.next(a[c]));)g=null,f=h,f.accepts()?(k=0,j=f):k>=0&&k++,c++,i++;if(k<0)for(var l=c-i;l<c;l++)e.push(a[l]);else{e.length>0&&(d.push(new ya(e)),e=[]),c-=k,i-=k;var m=j.emit();d.push(new m(a.slice(c-i,c)))}}return e.length>0&&d.push(new ya(e)),d},ob=Object.freeze({State:q,TOKENS:Ba,run:nb,start:Da});Array.isArray||(Array.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)});var pb=function(a){return nb(sa(a))},qb=function(a){for(var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,c=pb(a),d=[],e=0;e<c.length;e++){var f=c[e];!f.isLink||b&&f.type!==b||d.push(f.toObject())}return d},rb=function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,c=pb(a);return 1===c.length&&c[0].isLink&&(!b||c[0].type===b)};b.find=qb,b.inherits=c,b.options=n,b.parser=ob,b.scanner=ua,b.test=rb,b.tokenize=pb}(self.linkify=self.linkify||{})}(),function(a,b){var c=function(a){function b(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function c(a){return a.replace(/"/g,"&quot;")}function d(a){if(!a)return"";var b=[];for(var d in a){var e=a[d]+"";b.push(d+'="'+c(e)+'"')}return b.join(" ")}function e(a){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e=new h(e);for(var g=f(a),i=[],j=0;j<g.length;j++){var k=g[j];if("nl"===k.type&&e.nl2br)i.push("<br>\n");else if(k.isLink&&e.check(k)){var l=e.resolve(k),m=l.formatted,n=l.formattedHref,o=l.tagName,p=l.className,q=l.target,r=l.attributes,s="<"+o+' href="'+c(n)+'"';p&&(s+=' class="'+c(p)+'"'),q&&(s+=' target="'+c(q)+'"'),r&&(s+=" "+d(r)),s+=">"+b(m)+"</"+o+">",i.push(s)}else i.push(b(k.toString()))}return i.join("")}var f=a.tokenize,g=a.options,h=g.Options;return String.prototype.linkify||(String.prototype.linkify=function(a){return e(this,a)}),e}(b);a.linkifyStr=c}(window,linkify),this.JSON||(this.JSON={}),function(){function f(a){return a<10?"0"+a:a}function quote(a){return escapable.lastIndex=0,escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function str(a,b){var c,d,e,f,g,h=gap,i=b[a];switch(i&&"object"==typeof i&&"function"==typeof i.toJSON&&(i=i.toJSON(a)),"function"==typeof rep&&(i=rep.call(b,a,i)),typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";if(gap+=indent,g=[],"[object Array]"===Object.prototype.toString.apply(i)){for(f=i.length,c=0;c<f;c+=1)g[c]=str(c,i)||"null";return e=0===g.length?"[]":gap?"[\n"+gap+g.join(",\n"+gap)+"\n"+h+"]":"["+g.join(",")+"]",gap=h,e}if(rep&&"object"==typeof rep)for(f=rep.length,c=0;c<f;c+=1)"string"==typeof(d=rep[c])&&(e=str(d,i))&&g.push(quote(d)+(gap?": ":":")+e);else for(d in i)Object.hasOwnProperty.call(i,d)&&(e=str(d,i))&&g.push(quote(d)+(gap?": ":":")+e);return e=0===g.length?"{}":gap?"{\n"+gap+g.join(",\n"+gap)+"\n"+h+"}":"{"+g.join(",")+"}",gap=h,e}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(a){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(a){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(a,b,c){var d;if(gap="",indent="","number"==typeof c)for(d=0;d<c;d+=1)indent+=" ";else"string"==typeof c&&(indent=c);if(rep=b,b&&"function"!=typeof b&&("object"!=typeof b||"number"!=typeof b.length))throw new Error("JSON.stringify");return str("",{"":a})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&"object"==typeof e)for(c in e)Object.hasOwnProperty.call(e,c)&&(d=walk(e,c),void 0!==d?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}();var $,Util,gettext,_gettext,_ref,_t;gettext=null,"undefined"!=typeof Gettext&&null!==Gettext?(_gettext=new Gettext({domain:"annotator"}),gettext=function(a){return _gettext.gettext(a)}):gettext=function(a){return a},_t=function(a){return gettext(a)},("undefined"!=typeof jQuery&&null!==jQuery&&null!=(_ref=jQuery.fn)?_ref.jquery:void 0)||console.error(_t("Annotator requires jQuery: have you included lib/vendor/jquery.js?")),JSON&&JSON.parse&&JSON.stringify||console.error(_t("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?")),$=jQuery,Util={},Util.flatten=function(a){var b;return(b=function(a){var c,d,e,f;for(d=[],e=0,f=a.length;e<f;e++)c=a[e],d=d.concat(c&&$.isArray(c)?b(c):c);return d})(a)},Util.contains=function(a,b){var c;for(c=b;null!=c;){if(c===a)return!0;c=c.parentNode}return!1},Util.getTextNodes=function(a){var b;return b=function(a){var c;if(a&&a.nodeType!==Node.TEXT_NODE){if(c=[],a.nodeType!==Node.COMMENT_NODE)for(a=a.lastChild;a;)c.push(b(a)),a=a.previousSibling;return c.reverse()}return a},a.map(function(){return Util.flatten(b(this))})},Util.getLastTextNodeUpTo=function(a){var b;if(a){switch(a.nodeType){case Node.TEXT_NODE:return a;case Node.ELEMENT_NODE:if(null!=a.lastChild&&null!=(b=Util.getLastTextNodeUpTo(a.lastChild)))return b}return a=a.previousSibling,null!=a?Util.getLastTextNodeUpTo(a):null}},Util.getFirstTextNodeNotBefore=function(a){var b;if(a){switch(a.nodeType){case Node.TEXT_NODE:return a;case Node.ELEMENT_NODE:if(null!=a.firstChild&&null!=(b=Util.getFirstTextNodeNotBefore(a.firstChild)))return b}return a=a.nextSibling,null!=a?Util.getFirstTextNodeNotBefore(a):null}},Util.readRangeViaSelection=function(a){var b;return b=Util.getGlobal().getSelection(),b.removeAllRanges(),b.addRange(a.toRange()),b.toString()},Util.xpathFromNode=function(a,b){var c;try{c=simpleXPathJQuery.call(a,b)}catch(d){d,console.log("jQuery-based XPath construction failed! Falling back to manual."),c=simpleXPathPure.call(a,b)}return c},Util.nodeFromXPath=function(a,b){var c,d,e,f,g,h,i,j;for(g=a.substring(1).split("/"),e=b,h=0,i=g.length;h<i;h++)f=g[h],j=f.split("["),d=j[0],c=j[1],c=null!=c?parseInt((null!=c?c.split("]"):void 0)[0]):1,e=findChild(e,d.toLowerCase(),c);return e},Util.escape=function(a){return a.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},Util.uuid=function(){var a;return a=0,function(){return a++}}(),Util.getGlobal=function(){return function(){return this}()},Util.maxZIndex=function(a){var b,c;return b=function(){var b,d,e;for(e=[],b=0,d=a.length;b<d;b++)c=a[b],"static"===$(c).css("position")?e.push(-1):e.push(parseFloat($(c).css("z-index"))||-1);return e}(),Math.max.apply(Math,b)},Util.mousePosition=function(a,b){var c,d;return"absolute"!==(d=$(b).css("position"))&&"fixed"!==d&&"relative"!==d&&(b=$(b).offsetParent()[0]),c=$(b).offset(),{top:a.pageY-c.top,left:a.pageX-c.left}},Util.preventEventDefault=function(a){return null!=a&&"function"==typeof a.preventDefault?a.preventDefault():void 0};var fn,functions,_i,_j,_len,_len1,__slice=[].slice;if(functions=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"],"undefined"!=typeof console&&null!==console)for(null==console.group&&(console.group=function(a){return console.log("GROUP: ",a)}),null==console.groupCollapsed&&(console.groupCollapsed=console.group),_i=0,_len=functions.length;_i<_len;_i++)fn=functions[_i],null==console[fn]&&(console[fn]=function(){return console.log(_t("Not implemented:")+" console."+name)});else{for(this.console={},_j=0,_len1=functions.length;_j<_len1;_j++)fn=functions[_j],this.console[fn]=function(){};this.console.error=function(){var a;return a=1<=arguments.length?__slice.call(arguments,0):[],alert("ERROR: "+a.join(", "))},this.console.warn=function(){var a;return a=1<=arguments.length?__slice.call(arguments,0):[],alert("WARNING: "+a.join(", "))}}var Delegator,__slice=[].slice,__hasProp={}.hasOwnProperty;Delegator=function(){function a(a,b){this.options=$.extend(!0,{},this.options,b),this.element=$(a),this._closures={},this.on=this.subscribe,this.addEvents()}return a.prototype.events={},a.prototype.options={},a.prototype.element=null,a.prototype.destroy=function(){return this.removeEvents()},a.prototype.addEvents=function(){var b,c,d,e,f;for(e=a._parseEvents(this.events),f=[],c=0,d=e.length;c<d;c++)b=e[c],f.push(this._addEvent(b.selector,b.event,b.functionName));return f},a.prototype.removeEvents=function(){var b,c,d,e,f;for(e=a._parseEvents(this.events),f=[],c=0,d=e.length;c<d;c++)b=e[c],f.push(this._removeEvent(b.selector,b.event,b.functionName));return f},a.prototype._addEvent=function(b,c,d){var e;return e=function(a){return function(){return a[d].apply(a,arguments)}}(this),""===b&&a._isCustomEvent(c)?this.subscribe(c,e):this.element.delegate(b,c,e),this._closures[b+"/"+c+"/"+d]=e,this},a.prototype._removeEvent=function(b,c,d){var e;return e=this._closures[b+"/"+c+"/"+d],""===b&&a._isCustomEvent(c)?this.unsubscribe(c,e):this.element.undelegate(b,c,e),delete this._closures[b+"/"+c+"/"+d],this},a.prototype.publish=function(){return this.element.triggerHandler.apply(this.element,arguments),this},a.prototype.subscribe=function(a,b){var c;return c=function(){return b.apply(this,[].slice.call(arguments,1))},c.guid=b.guid=$.guid+=1,this.element.bind(a,c),this},a.prototype.unsubscribe=function(){return this.element.unbind.apply(this.element,arguments),this},a}(),Delegator._parseEvents=function(a){var b,c,d,e,f,g,h;c=[];for(e in a)d=a[e],h=e.split(" "),f=2<=h.length?__slice.call(h,0,g=h.length-1):(g=0,[]),b=h[g++],c.push({selector:f.join(" "),event:b,functionName:d});return c},Delegator.natives=function(){var a,b,c;return b=function(){var b,d;b=jQuery.event.special,d=[];for(a in b)__hasProp.call(b,a)&&(c=b[a],d.push(a));return d}(),"blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/).concat(b)}(),Delegator._isCustomEvent=function(a){return a=a.split(".")[0],-1===$.inArray(a,Delegator.natives)};var Range,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Range={},Range.sniff=function(a){return null!=a.commonAncestorContainer?new Range.BrowserRange(a):"string"==typeof a.start?new Range.SerializedRange(a):a.start&&"object"==typeof a.start?new Range.NormalizedRange(a):(console.error(_t("Could not sniff range type")),!1)},Range.nodeFromXPath=function(a,b){var c,d,e,f,g;return null==b&&(b=document),d=function(a,c){null==c&&(c=null);try{var d=document.evaluate("."+a,b,c,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue;return null===d?Util.nodeFromXPath(a,b):d}catch(c){return c,console.log("XPath evaluation failed."),console.log("Trying fallback..."),Util.nodeFromXPath(a,b)}},$.isXMLDoc(document.documentElement)?(c=document.createNSResolver(null===document.ownerDocument?document.documentElement:document.ownerDocument.documentElement),f=d(a,c),f||(a=function(){var b,c,d,e;for(d=a.split("/"),e=[],b=0,c=d.length;b<c;b++)g=d[b],g&&-1===g.indexOf(":")?e.push(g.replace(/^([a-z]+)/,"xhtml:$1")):e.push(g);return e}().join("/"),e=document.lookupNamespaceURI(null),c=function(a){return"xhtml"===a?e:document.documentElement.getAttribute("xmlns:"+a)},f=d(a,c)),f):d(a)},Range.RangeError=function(a){function b(a,c,d){this.type=a,this.message=c,this.parent=null!=d?d:null,b.__super__.constructor.call(this,this.message)}return __extends(b,a),b}(Error),Range.BrowserRange=function(){function a(a){this.commonAncestorContainer=a.commonAncestorContainer,this.startContainer=a.startContainer,this.startOffset=a.startOffset,this.endContainer=a.endContainer,this.endOffset=a.endOffset}return a.prototype.normalize=function(a){var b,c,d,e;if(this.tainted)return console.error(_t("You may only call normalize() once on a BrowserRange!")),!1;if(this.tainted=!0,e={},this.startContainer.nodeType===Node.ELEMENT_NODE?(e.start=Util.getFirstTextNodeNotBefore(this.startContainer.childNodes[this.startOffset]),e.startOffset=0):(e.start=this.startContainer,e.startOffset=this.startOffset),this.endContainer.nodeType===Node.ELEMENT_NODE){if(null!=(c=this.endContainer.childNodes[this.endOffset])){for(b=c;null!=b&&b.nodeType!==Node.TEXT_NODE;)b=b.firstChild;null!=b&&(e.end=b,e.endOffset=0)}null==e.end&&(c=this.endOffset?this.endContainer.childNodes[this.endOffset-1]:this.endContainer.previousSibling,e.end=Util.getLastTextNodeUpTo(c),e.endOffset=e.end.nodeValue.length)}else e.end=this.endContainer,e.endOffset=this.endOffset;for(d={},e.startOffset>0?e.start.nodeValue.length>e.startOffset?d.start=e.start.splitText(e.startOffset):d.start=e.start.nextSibling:d.start=e.start,e.start===e.end?(d.start.nodeValue.length>e.endOffset-e.startOffset&&d.start.splitText(e.endOffset-e.startOffset),d.end=d.start):(e.end.nodeValue.length>e.endOffset&&e.end.splitText(e.endOffset),d.end=e.end),d.commonAncestor=this.commonAncestorContainer;d.commonAncestor.nodeType!==Node.ELEMENT_NODE;)d.commonAncestor=d.commonAncestor.parentNode;return new Range.NormalizedRange(d)},a.prototype.serialize=function(a,b){return this.normalize(a).serialize(a,b)},a}(),Range.NormalizedRange=function(){function a(a){this.commonAncestor=a.commonAncestor,this.start=a.start,this.end=a.end}return a.prototype.normalize=function(a){return this},a.prototype.limit=function(a){var b,c,d,e,f,g;if(b=$.grep(this.textNodes(),function(b){return b.parentNode===a||$.contains(a,b.parentNode)}),!b.length)return null;for(this.start=b[0],this.end=b[b.length-1],d=$(this.start).parents(),g=$(this.end).parents(),e=0,f=g.length;e<f;e++)if(c=g[e],-1!==d.index(c)){this.commonAncestor=c;break}return this},a.prototype.serialize=function(a,b){var c,d,e;return d=function(c,d){var e,f,g,h,i,j,k,l;for(h=b?$(c).parents(":not("+b+")").eq(0):$(c).parent(),j=Util.xpathFromNode(h,a)[0],i=Util.getTextNodes(h),f=i.slice(0,i.index(c)),g=0,k=0,l=f.length;k<l;k++)e=f[k],g+=e.nodeValue.length;return d?[j,g+c.nodeValue.length]:[j,g]},e=d(this.start),c=d(this.end,!0),new Range.SerializedRange({start:e[0],end:c[0],startOffset:e[1],endOffset:c[1]})},a.prototype.text=function(){var a;return function(){var b,c,d,e;for(d=this.textNodes(),e=[],b=0,c=d.length;b<c;b++)a=d[b],e.push(a.nodeValue);return e}.call(this).join("")},a.prototype.textNodes=function(){var a,b,c,d;return c=Util.getTextNodes($(this.commonAncestor)),d=[c.index(this.start),c.index(this.end)],b=d[0],a=d[1],$.makeArray(c.slice(b,+a+1||9e9))},a.prototype.toRange=function(){var a;return a=document.createRange(),a.setStartBefore(this.start),a.setEndAfter(this.end),a},a}(),Range.SerializedRange=function(){function a(a){this.start=a.start,this.startOffset=a.startOffset,this.end=a.end,this.endOffset=a.endOffset}return a.prototype.normalize=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o;for(g={},n=["start","end"],j=0,l=n.length;j<l;j++){f=n[j];try{e=Range.nodeFromXPath(this[f],a)}catch(a){throw c=a,new Range.RangeError(f,"Error while finding "+f+" node: "+this[f]+": "+c,c)}if(!e)throw new Range.RangeError(f,"Couldn't find "+f+" node: "+this[f]);for(d=0,h=this[f+"Offset"],"end"===f&&h--,o=Util.getTextNodes($(e)),k=0,m=o.length;k<m;k++){if(i=o[k],d+i.nodeValue.length>h){g[f+"Container"]=i,g[f+"Offset"]=this[f+"Offset"]-d;break}d+=i.nodeValue.length}if(null==g[f+"Offset"])throw new Range.RangeError(f+"offset","Couldn't find offset "+this[f+"Offset"]+" in element "+this[f])}return b=null==document.compareDocumentPosition?function(a,b){return a.contains(b)}:function(a,b){return 16&a.compareDocumentPosition(b)},$(g.startContainer).parents().each(function(){if(b(this,g.endContainer))return g.commonAncestorContainer=this,!1}),new Range.BrowserRange(g).normalize(a)},a.prototype.serialize=function(a,b){return this.normalize(a).serialize(a,b)},a.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}},a}();var Annotator,g,_Annotator,_ref,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};_Annotator=this.Annotator;var language=window.annotationLocale||"en-US";Annotator=function(a){function b(a,c){if(this.onDeleteAnnotation=__bind(this.onDeleteAnnotation,this),this.onEditAnnotation=__bind(this.onEditAnnotation,this),this.onAdderClick=__bind(this.onAdderClick,this),this.onAdderMousedown=__bind(this.onAdderMousedown,this),this.onHighlightMouseover=__bind(this.onHighlightMouseover,this),this.onHighlightClick=__bind(this.onHighlightClick,this),this.checkForEndSelection=__bind(this.checkForEndSelection,this),this.checkForStartSelection=__bind(this.checkForStartSelection,this),this.clearViewerHideTimer=__bind(this.clearViewerHideTimer,this),this.startViewerHideTimer=__bind(this.startViewerHideTimer,this),this.showViewer=__bind(this.showViewer,this),this.onEditorSubmit=__bind(this.onEditorSubmit,this),this.onEditorHide=__bind(this.onEditorHide,this),this.showEditor=__bind(this.showEditor,this),this.getSelectedAnnotations=__bind(this.getSelectedAnnotations,this),b.__super__.constructor.apply(this,arguments),this.plugins={},!b.supported())return this;this.options.readOnly||this._setupDocumentEvents(),this._setupWrapper()._setupViewer()._setupEditor(),this._setupDynamicStyle(),this.adder=$(this.html.adder).appendTo(this.wrapper).hide(),b._instances.push(this)}return __extends(b,a),b.prototype.events={".annotator-adder click":"onAdderClick",".annotator-adder mousedown":"onAdderMousedown",".annotator-hl click":"onHighlightClick"},b.prototype.html={adder:'<div class="annotator-adder"><button>'+_t("Annotate")+"</button></div>",wrapper:'<div class="annotator-wrapper"></div>'},b.prototype.options={readOnly:!1},b.prototype.plugins={},b.prototype.isShareable=!1,b.prototype.editor=null,b.prototype.viewer=null,b.prototype.selectedRanges=null,b.prototype.mouseIsDown=!1,b.prototype.selectedAnnArr=[],b.prototype.ignoreMouseup=!1,b.prototype.viewerHideTimer=null,b.prototype._setupWrapper=function(){return this.element.addClass("annotation-wrapper"),this.wrapper=this.element,this},b.prototype._setupViewer=function(){return this.viewer=new b.Viewer({readOnly:this.options.readOnly}),this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:function(a){return function(b,c){return c.text?$(b).html(Util.escape(c.text)):$(b).html("<i>"+_t("No Comment")+"</i>"),a.publish("annotationViewerTextField",[b,c])}}(this)}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer}),this},b.prototype._setupEditor=function(){return this.editor=new b.Editor,this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:locale_data[language].add_note,load:function(a,b){return $(a).find("textarea").val(b.text||"")},submit:function(a,b){return b.text=$(a).find("textarea").val()}}),this.editor.element.appendTo(this.wrapper),this},b.prototype._setupDocumentEvents=function(){return $(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),this},b.prototype._setupDynamicStyle=function(){var a,b,c,d;return c=$("#annotator-dynamic-style"),c.length||(c=$('<style id="annotator-dynamic-style"></style>').appendTo(document.head)),b="*"+function(){var a,b,c,e;for(c=["adder","outer","notice","filter"],e=[],a=0,b=c.length;a<b;a++)d=c[a],e.push(":not(.annotator-"+d+")");return e}().join(""),a=Util.maxZIndex($(document.body).find(b)),a=Math.max(a,1e3),c.text([".annotator-adder, .annotator-outer, .annotator-notice {","  z-index: 20;","}",".annotator-filter {","  z-index: 20;","}"].join("\n")),this},b.prototype.destroy=function(){var a,c,d,e;b.__super__.destroy.apply(this,arguments),$(document).unbind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),$("#annotator-dynamic-style").remove(),this.adder.remove(),this.viewer.destroy(),this.editor.destroy(),this.wrapper.find(".annotator-hl").each(function(){return $(this).contents().insertBefore(this),$(this).remove()}),this.wrapper.contents().insertBefore(this.wrapper),this.wrapper.remove(),this.element.data("annotator",null),e=this.plugins;for(c in e)e[c],"function"==typeof(d=this.plugins[c]).destroy&&d.destroy();if(-1!==(a=b._instances.indexOf(this)))return b._instances.splice(a,1)},b.prototype.getSelectedRanges=function(){var a,b,c,d,e,f,g,h,i;for(g=Util.getGlobal().getSelection(),e=[],f=[],g.isCollapsed||(e=function(){var e,h,i;for(i=[],b=e=0,h=g.rangeCount;0<=h?e<h:e>h;b=0<=h?++e:--e)d=g.getRangeAt(b),a=new Range.BrowserRange(d),c=a.normalize().limit(this.wrapper[0]),null===c&&f.push(d),i.push(c);return i}.call(this),g.removeAllRanges()),h=0,i=f.length;h<i;h++)d=f[h],g.addRange(d);return $.grep(e,function(a){return a&&g.addRange(a.toRange()),a})},b.prototype.createAnnotation=function(){var a;return a={},this.publish("beforeAnnotationCreated",[a]),a},b.prototype.setupAnnotation=function(a){var b,c,d,e,f,g,h,i,j,k;for(f=this.wrapper[0],a.ranges||(a.ranges=this.selectedRanges),d=[],k=a.ranges,g=0,i=k.length;g<i;g++){e=k[g];try{d.push(Range.sniff(e).normalize(f))}catch(c){if(!((b=c)instanceof Range.RangeError))throw b;this.publish("rangeNormalizeFail",[a,e,b])}}for(a.quote=a.quote||[],a.ranges=[],a.highlights=[],h=0,j=d.length;h<j;h++)c=d[h],c.color=a.color,c.note=a.text,Array.isArray(a.quote)&&a.quote.push($.trim(c.text())),a.ranges.push(c.serialize(this.wrapper[0],".annotator-hl")),$.merge(a.highlights,this.highlightRange(c));return Array.isArray(a.quote)&&(a.quote=a.quote.join(" / ")),$(a.highlights).data("annotation",a),$(a.highlights).attr("data-annotation-id",a.id),$(a.highlights).attr("data-ann-id",a.id),$(a.highlights).attr("shareable",a.shareable),a.createdTimestamp=(new Date).toISOString(),a},b.prototype.updateAnnotation=function(a){return this.publish("beforeAnnotationUpdated",[a]),$(a.highlights).attr("data-annotation-id",a.id),this.publish("annotationUpdated",[a]),a},b.prototype.deleteAnnotation=function(a){var b,c,d,e;if(null!=a.highlights)for($(a.highlights).find(".annotator-handle").each(function(a){"true"!=$(this).closest(".annotator-hl").attr("shareable")&&$(this).remove()}),$(".annotator-handle").css({"margin-top":"6px"}),e=a.highlights,c=0,d=e.length;c<d;c++)b=e[c],null!=b.parentNode&&(b.childNodes[0],$(b).replaceWith(b.childNodes));return this.alignMathMlNote(),this.alignNotes(),this.publish("annotationDeleted",[a]),a},b.prototype.shareAnnotations=function(a){return this.isShareable=a},b.prototype.updateAnnotationId=function(a){$(".annotator-hl").each(function(){Date.parse($(this).data("annotation").createdTimestamp)==a.createdTimestamp&&($(this).data("annotation").id=a.id,$(this).attr("data-ann-id",a.id))})},b.prototype.loadAnnotations=function(a,b){var c,d;null==a&&(a=[]),b&&(this.editor.currentAnnotation=a[0]),d=function(a){return function(b){var e,f,g,h;for(null==b&&(b=[]),f=b.splice(0,10),g=0,h=f.length;g<h;g++)e=f[g],a.setupAnnotation(e);return b.length>0?setTimeout(function(){return d(b)},10):a.publish("annotationsLoaded",[c])}}(this),c=a.slice(),d(a),window.getSelection().removeAllRanges();var e=this;return setTimeout(function(){e.alignNotes(),e.alignMathMlNote()},1600),this},b.prototype.dumpAnnotations=function(){return this.plugins.Store?this.plugins.Store.dumpAnnotations():(console.warn(_t("Can't dump annotations without Store plugin.")),!1)},b.prototype.alignMathMlNote=function(){},b.prototype.alignNotes=function(){for(var a=document.getElementsByClassName("annotator-handle"),b=0;b<a.length-1;b++)for(var c=b+1;c<a.length;c++){var d=a[b],e=a[c],f=a[b].getBoundingClientRect(),g=e.getBoundingClientRect(),h=!(f.right<g.left||f.left>g.right||f.bottom<g.top||f.top>g.bottom);h&&"visible"===$(d).css("visibility")&&"visible"===$(e).css("visibility")&&(e.style.marginTop=parseInt($(e).css("margin-top"))+30+"px")}},b.prototype.highlightRange=function(a,b){var c,d,e,f,g,h,i,j;null==b&&(b="annotator-hl"),b+=" highlight-note",e=/^\s*$/;var k="",l="",m="";for("#FFD232"==a.color?(k="rgba(255,210,50,0.4)",l="#ffedad",m="Q"):"#55DF49"==a.color?(k=l="#bbf2b6",m="M"):"#FC92CF"==a.color?(k=l="#fed3ec",m="O"):"#ccf5fd"==a.color?(k=l="#ccf5fd",m="I"):k=l=a.color,c=$("<span class='"+b+"' style=background:"+k+"></span>"),j=$("<span class='annotator-handle' style=background-color:"+l+">"+m+"</span>"),h=a.textNodes(),i=[],f=0,g=h.length;f<g;f++)d=h[f],e.test(d.nodeValue)||$(d).closest(".annotator-handle").length||(i.push($(d).wrapAll(c).parent().prepend(j).show()[0]),$(d).closest(".pxereaderSearchHighlight").length>0&&$(d).parent().find(".annotator-handle").text(m).css("background-color",a.color),j="");return window.getSelection().removeAllRanges(),window.getSelection().addRange(a.toRange()),this.alignMathMlNote(),this.alignNotes(),i},b.prototype.highlightRanges=function(a,b){var c,d,e,f;for(null==b&&(b="annotator-hl"),c=[],e=0,f=a.length;e<f;e++)d=a[e],$.merge(c,this.highlightRange(d,b));return c},b.prototype.addPlugin=function(a,c){var d,e;return this.plugins[a]?console.error(_t("You cannot have more than one instance of any plugin.")):(d=b.Plugin[a],"function"==typeof d?(this.plugins[a]=new d(this.element[0],c),this.plugins[a].annotator=this,"function"==typeof(e=this.plugins[a]).pluginInit&&e.pluginInit()):console.error(_t("Could not load ")+a+_t(" plugin. Have you included the appropriate <script> tag?"))),this},b.prototype.showEditor=function(a,b,c,d){var e=0,f=a?a.id:"",g=$("span[data-ann-id="+f+"]")[0];if(g){var h=0;$(g).find(".annotator-handle").length>0&&(h=isNaN(parseInt($(g.innerHTML).css("margin-top")))?0:parseInt($(g.innerHTML).css("margin-top"))),e=$(g).offset().top+h}else e=b.top+30;var i,j=window.getSelection().getRangeAt(0);return $(j.startContainer).hasClass("annotator-color-container")&&0==c&&"none"==$(".annotator-editor .annotator-panel-2 .annotator-listing").css("display")&&(c=!0),i={top:e},this.editor.element.css(i),this.editor.load(a,this.isShareable,e,d),this.publish("annotationEditorShown",[this.editor,a]),""!=j.toString()&&($(j.startContainer).hasClass("annotator-hl")||$(j.endContainer).hasClass("annotator-hl"))?$(".annotator-editor").addClass("overlapingpopup"):$(".annotator-editor").removeClass("overlapingpopup"),this},b.prototype.onEditorHide=function(){return window.currAnn=[],this.publish("annotationEditorHidden",[this.editor]),this.ignoreMouseup=!1},b.prototype.onEditorSubmit=function(a){if(this.alignMathMlNote(),this.alignNotes(),!a.shareable)return this.publish("annotationEditorSubmit",[this.editor,a])},b.prototype.showViewer=function(a,b){return this.viewer.element.css(b),this.viewer.load(a),this.publish("annotationViewerShown",[this.viewer,a])},b.prototype.startViewerHideTimer=function(){if(!this.viewerHideTimer)return this.viewerHideTimer=setTimeout(this.viewer.hide,250)},b.prototype.clearViewerHideTimer=function(){return clearTimeout(this.viewerHideTimer),this.viewerHideTimer=!1},b.prototype.checkForStartSelection=function(a){return a&&this.isAnnotator(a.target)||this.startViewerHideTimer(),this.mouseIsDown=!0},b.prototype.getSelectedAnnotations=function(){var a=window.getSelection().getRangeAt(0),b=$(a.cloneContents()).context.children,c=a.commonAncestorContainer,d=[];if($(b).hasClass("annotator-editor"))return d.push(1,2),d;if(0==b.length){var e=a.cloneContents().textContent;b=[],e==a.startContainer.innerText&&$(a.startContainer).hasClass("annotator-hl")?b.push(a.startContainer):$(c).hasClass("annotator-hl")&&b.push(c)}if(b.length>0)for(var f,g,h,i=0;i<=b.length;i++){if(f=$(b[i]).find(".annotator-hl"),f.length>0)for(var j=0;j<=f.length;j++)g=$(f[j]).attr("data-ann-id"),h=$(f[j]).attr("shareable"),void 0!==g&&$.inArray(g,d)<0&&(h&&"false"!==h||d.push(g));f.context&&f.context.hasAttribute("data-ann-id")?(g=$(f.context).attr("data-ann-id"),h=$(f.context).attr("shareable"),void 0!==g&&$.inArray(g,d)<0&&(h&&"false"!==h||d.push(g))):0===d.length&&$(c).hasClass("annotator-hl")&&(g=$(c).attr("data-ann-id"),h=$(c).attr("shareable"),void 0!==g&&$.inArray(g,d)<0&&(h&&"false"!==h||d.push(g)))}return d},b.prototype.checkForEndSelection=function(a){if($(a.target).closest(".aquila-image-viewer, .ReactModalPortal").length)return!1;var b,c,d,e,f;if(this.mouseIsDown=!1,this.selectedAnnArr=[],this.ignoreMouseup=!$(a.target).hasClass("annotator-confirm-delete")&&this.ignoreMouseup,!this.ignoreMouseup){if(this.selectedRanges=this.getSelectedRanges(),f=this.selectedRanges,f.length>0&&(this.selectedAnnArr=this.getSelectedAnnotations(),this.selectedAnnArr.length>1))return void window.getSelection().removeAllRanges();for(d=0,e=f.length;d<e;d++)if(c=f[d],b=c.commonAncestor,this.isAnnotator(b))return;return a&&this.selectedRanges.length?(this.onAdderClick(a),this.onAdderMousedown(),this.adder):this.adder.hide()}},b.prototype.isAnnotator=function(a){return!!$(a).parents().addBack().filter("[class^=annotator-]").not("[class^=annotator-hl]").not(this.wrapper).length},b.prototype.onHighlightMouseover=function(a){var b;return this.clearViewerHideTimer(),!this.mouseIsDown&&(this.viewer.isShown()&&this.viewer.hide(),b=$(a.target).parents(".annotator-hl").addBack().map(function(){return $(this).data("annotation")}).toArray(),this.showViewer(b,Util.mousePosition(a,this.wrapper[0])))},b.prototype.onHighlightClick=function(a){a.stopPropagation(),this.alignNotes(),this.alignMathMlNote();var b,c=0;if(this.selectedAnnArr.length>0)return!1;var d=$(a.target).closest(".annotator-hl").addBack().map(function(){return $(this).data("annotation")}).toArray();for(b=0;b<d.length;b++)$(d)[b].shareable&&(c=b),$(d)[b].id||c++;this.showEditor(d[c],Util.mousePosition(a,this.wrapper[0]),!1)},b.prototype.onAdderMousedown=function(a){return null!=a&&a.preventDefault(),this.ignoreMouseup=!0},b.prototype.clearTextSelection=function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},b.prototype.onAdderClick=function(a){var b,c,d,e,f,g,h=[],i=[],j=window.getSelection(),k=j.getRangeAt(0);if(h=this.getSelectedAnnotations(),h.length>0){var l=$(a.target).addBack().find(".annotator-hl");if(l.length>0)for(var m=0;m<=l.length;m++){var n=$(l[m]).attr("data-ann-id");void 0!==n&&$.inArray(n,h)>=0&&(b=l[m])}else{var o=$(k.startContainer).hasClass("annotator-hl"),p=$(k.endContainer).hasClass("annotator-hl");o&&$.inArray($(k.startContainer).attr("data-ann-id"),h)>=0&&(b=$(k.startContainer)),p&&$.inArray($(k.endContainer).attr("data-ann-id"),h)>=0&&(b=$(k.endContainer))}!b&&l.context&&l.context.outerHTML.match(".annotator-hl")&&(b=l.context),i=$(b).parents(".annotator-hl").addBack().map(function(){return $(this).data("annotation")}).toArray()}return null!=a&&a.preventDefault(),this.adder.hide(),c=this.setupAnnotation(this.createAnnotation()),a.pageY=$(c.highlights).offset().top,f=Util.mousePosition(a,this.wrapper[0]),$(c.highlights).addClass("annotator-hl-temporary"),g=function(a){return function(){return e(),$(c.highlights).removeClass("annotator-hl-temporary"),a.publish("annotationCreated",[c])}}(this),d=function(a){return function(){return e(),a.deleteAnnotation(c)}}(this),e=function(a){return function(){return a.unsubscribe("annotationEditorHidden",d),a.unsubscribe("annotationEditorSubmit",g)}}(this),i.length>0&&h.length>0&&($(c)[0].text=$(i)[0].text,$(".annotator-edit-container").hide(),window.currAnn=$(i)[0]),this.subscribe("annotationEditorHidden",d),this.subscribe("annotationEditorSubmit",g),this.showEditor(c,f,!0,a)},b.prototype.onEditAnnotation=function(a){var b,c,d;return c=this.viewer.element.position(),d=function(c){return function(){return b(),c.updateAnnotation(a)}}(this),b=function(a){return function(){return a.unsubscribe("annotationEditorHidden",b),a.unsubscribe("annotationEditorSubmit",d)}}(this),this.subscribe("annotationEditorHidden",b),this.subscribe("annotationEditorSubmit",d),this.viewer.hide(),this.showEditor(a,c,!1)},b.prototype.onDeleteAnnotation=function(a){return this.viewer.hide(),this.deleteAnnotation(a)},b}(Delegator),Annotator.Plugin=function(a){function b(a,c){b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.pluginInit=function(){},b}(Delegator),g=Util.getGlobal(),null==(null!=(_ref=g.document)?_ref.evaluate:void 0)&&$.getScript("http://assets.annotateit.org/vendor/xpath.min.js"),null==g.getSelection&&$.getScript("http://assets.annotateit.org/vendor/ierange.min.js"),null==g.JSON&&$.getScript("http://assets.annotateit.org/vendor/json2.min.js"),null==g.Node&&(g.Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12}),Annotator.$=$,Annotator.Delegator=Delegator,Annotator.Range=Range,Annotator.Util=Util,Annotator._instances=[],Annotator._t=_t,Annotator.supported=function(){return function(){return!!this.getSelection}()},Annotator.noConflict=function(){return Util.getGlobal().Annotator=_Annotator,this},$.fn.annotator=function(a){var b;return b=Array.prototype.slice.call(arguments,1),this.each(function(){var c;return c=$.data(this,"annotator"),"destroy"===a?($.removeData(this,"annotator"),null!=c?c.destroy(b):void 0):c?a&&c[a].apply(c,b):(c=new Annotator(this,a),$.data(this,"annotator",c))})},this.Annotator=Annotator;var __hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Widget=function(a){function b(a,c){b.__super__.constructor.apply(this,arguments),this.classes=$.extend({},Annotator.Widget.prototype.classes,this.classes)}return __extends(b,a),b.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}},b.prototype.destroy=function(){return this.removeEvents(),this.element.remove()},b.prototype.checkOrientation=function(){var a,b,c,d,e;return this.resetOrientation(),e=$(Annotator.Util.getGlobal()),d=this.element.children(":first"),b=d.offset(),c={top:e.scrollTop(),right:e.width()+e.scrollLeft()},a={top:b.top,right:b.left+d.width()},a.top-c.top<0&&this.invertY(),a.right-c.right>0&&this.invertX(),this},b.prototype.resetOrientation=function(){return this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y),this},b.prototype.invertX=function(){return this.element.addClass(this.classes.invert.x),this},b.prototype.invertY=function(){return this.element.addClass(this.classes.invert.y),this},b.prototype.isInvertedY=function(){return this.element.hasClass(this.classes.invert.y)},b.prototype.isInvertedX=function(){return this.element.hasClass(this.classes.invert.x)},b}(Delegator);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Editor=function(a){function b(a){this.onCancelButtonMouseover=__bind(this.onCancelButtonMouseover,this),this.processKeypress=__bind(this.processKeypress,this),this.submit=__bind(this.submit,this),this.load=__bind(this.load,this),this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),this.onColorChange=__bind(this.onColorChange,this),this.onShareClick=__bind(this.onShareClick,this),this.onDeleteClick=__bind(this.onDeleteClick,this),this.onDeleteIconClick=__bind(this.onDeleteIconClick,this),this.onCancelClick=__bind(this.onCancelClick,this),this.onEditClick=__bind(this.onEditClick,this),this.onNoteChange=__bind(this.onNoteChange,this),b.__super__.constructor.call(this,$(this.html)[0],a),this.fields=[],this.annotation={}}__extends(b,a),b.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress",".annotator-color click":"onColorChange",".annotator-share click":"onShareClick",".annotator-confirm-delete click":"onDeleteClick",".annotator-edit-container click":"onEditClick",".annotator-listing textarea keyup":"onNoteChange",".annotator-delete-container click":"onDeleteIconClick",".annotator-confirm-cancel click":"onCancelClick",".annotator-color-select-container click":"onAnnotatorColorChange",".annotator-edit-Note-Panel-1-rect click":"onEditRectClick",".annotator-edit-Note-Panel-1-circle click":"onEditColorChange","#noteContainer click":"onNoteContainerClick"},b.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"},b.prototype.isShareable=null,b.prototype.textareaHeight=null,b.prototype.currentAnnotation=null,b.prototype.const={characters:3e3};var c=window.annotationLocale||"en-US",d='<div class="annotator-panel-1 annotator-panel-triangle">                   <div class="annotator-color-container">                    <div>                       <div class = "annotator-color-select-container yellowColorBtn" title = "Main ideas" value="#55DF49">                         <div class = "annotator-select-outer-circle positionAbs">                           <div class = "annotator-select-inner-circle hide" value="#55DF49"></div>                         </div>                         <div class = "annotator-select-rect positionRel annotator-Rect-Pos annotator-pane1-font annotator-pane1-rect-background-green">'+locale_data[c].mainIdeas+'</div>                       </div>                       <div class = "annotator-color-select-container" title = "Questions" value="#FFD232">                         <div class = "annotator-select-outer-circle positionAbs">                           <div class = "annotator-select-inner-circle hide" value="#FFD232"></div>                         </div>                         <div class = "annotator-select-rect positionRel annotator-Rect-Pos annotator-pane1-font annotator-pane1-rect-background-sepia">'+locale_data[c].questions+'</div>                       </div>                       <div class = "annotator-color-select-container" title = "Observations" value="#FC92CF">                         <div class = "annotator-select-outer-circle positionAbs">                           <div class = "annotator-select-inner-circle hide" value="#FC92CF"></div>                         </div>                         <div class = "annotator-select-rect positionRel annotator-Rect-Pos annotator-pane1-font annotator-pane1-rect-background-pink">'+locale_data[c].observations+'</div>                       </div>                     </div>                   </div>                   <div class = "annotator-select-container">                     <div>                       \x3c!-- div class="annotator-delete-container" title="'+locale_data[c].delete+'"></div --\x3e                       \x3c!-- div class="annotator-edit-container" title="'+locale_data[c].edit+'"></div --\x3e                     </div>                   </div>                   <div class = "edit-Note-Panel-1">  \x3c!-- Edit Note Panel--\x3e                    <div> \x3c!-- Edit Note circle--\x3e                      <div class = "edit-note-circle">                         <div class= "annotator-edit-Note-Panel-1-circle annotator-edit-Note-Panel-1-circle-green" value="#55DF49">                         </div>                         <div class= "annotator-edit-Note-Panel-1-circle annotator-edit-Note-Panel-1-circle-sepia" value="#FFD232">                         </div >                         <div class= "annotator-edit-Note-Panel-1-circle annotator-edit-Note-Panel-1-circle-pink" value="#FC92CF">                         </div >                       </div>                       <div class = "edit-note-rect"> \x3c!-- Edit Note Rectangle--\x3e                        <div>                           <div class = "annotator-select-rect hide annotator-pane1-font annotator-pane1-rect-background-green annotator-edit-Note-Panel-1-rect" value="#55DF49">'+locale_data[c].mainIdeas+'</div>                         </div>                                                         <div>                           <div class = "annotator-select-rect hide annotator-pane1-font annotator-pane1-rect-background-sepia annotator-edit-Note-Panel-1-rect" value="#FFD232">'+locale_data[c].questions+'</div>                         </div>                                                         <div>                           <div class = "annotator-select-rect hide annotator-pane1-font annotator-pane1-rect-background-pink annotator-edit-Note-Panel-1-rect" value="#FC92CF">'+locale_data[c].observations+'</div>                         </div>                         <div>                           <div class = "annotator-select-rect hide annotator-pane1-font annotator-pane1-rect-background-blue annotator-edit-Note-Panel-1-rect" value="#ccf5fd">'+locale_data[c].instructor+"</div>                         </div>                       </div>                                                   </div>                   </div>                 </div>",e='<div class="annotator-panel-3">                 <div class="annotator-controls">                   <div class="annotator-delete-container" title="'+locale_data[c].delete+'">                   </div>                   <div class="ann-cancel-delete-confirm-section hide">                     <div class="ann-confirm-section">                       <label class="annotator-confirm">'+locale_data[c].confirm+'?</label>                     </div>                     <div class = "ann-canceldelete-section">                       <a class="annotator-confirm-delete" title="'+locale_data[c].delete+'">'+locale_data[c].delete+'</a>                       <a class="annotator-confirm-cancel" title="'+locale_data[c].cancel+'">'+locale_data[c].cancel+'</a>                     </div>                   </div>                   \x3c!--div class="ann-share-section">                     <label class="annotator-share-text">'+locale_data[c].share+'</label>                       <div class="annotator-share" title="'+locale_data[c].share+'">                       </div>                   </div --\x3e                   <div class="ann-cancelsave-section">                     \x3c!-- a class="annotator-cancel" title="'+locale_data[c].cancel+'">'+locale_data[c].cancel+'</a >                     <a class="annotator-save annotator-focus" title="'+locale_data[c].save+'">'+locale_data[c].save+"</a --\x3e                   </div>                 </div>               </div>",f=(locale_data[c].confirm,locale_data[c].delete,locale_data[c].delete,locale_data[c].cancel,locale_data[c].cancel,'<li style="display:none"; class="characters-left"><span id="letter-count">'+b.prototype.const.characters+'</span id="letter-text">  '+locale_data[c].charleft+"<span><span></li>");return b.prototype.html='<div class="annotator-outer annotator-editor hide-note"><form class="annotator-widget">'+d+'<div class="annotator-panel-2"><ul class="annotator-listing"></ul></div>'+e+"</form></div>",b.prototype.options={},b.prototype.randomId=0,b.prototype.onAnnotatorColorChange=function(a){var b;a.target.parentElement.getAttribute("title")?(a.target.parentElement.getAttribute("title"),b=a.target.parentElement):a.target.getAttribute("title")&&(a.target.getAttribute("title"),b=a.target),$(".annotator-select-inner-circle").hide(),$(".annotator-select-outer-circle").removeClass("circleborder"),$(b).find(".annotator-select-inner-circle").show(),$(b).find(".annotator-select-outer-circle").addClass("circleborder"),$(".ann-cancel-delete-confirm-section").hide(),$(".annotator-delete-container").show(),this.onColorChange(b)},b.prototype.onNoteContainerClick=function(a){$("#noteContainer").hide();var b=$(".annotator-editor");b.css({top:b.position().top}),$(".annotator-panel-2").find("textarea").show().css({"pointer-events":"all",opacity:"1"}),$(".annotator-panel-2").find("textarea").focus(),$(".annotator-panel-triangle").addClass("annotator-panel-triangle1").removeClass("annotator-panel-triangle")},b.prototype.onEditColorChange=function(a){a.preventDefault();var b=$(".edit-note-circle"),c=$(a.target).attr("value");b.find(".annotator-edit-Note-Panel-1-circle").css({border:"0px",height:"18px",width:"18px"}),b.find("[value='"+c+"']").css({border:"solid 1px #19a6a4",height:"20px",width:"20px"}),$(".annotator-edit-Note-Panel-1-rect").hide(),$(".edit-note-rect").find("[value='"+c+"']").show(),this.onColorChange(a.target)},b.prototype.onEditRectClick=function(a){var b=$(".edit-note-circle"),c=$(a.target).attr("value");b.show(),b.find(".annotator-edit-Note-Panel-1-circle").css({border:"0px",height:"18px",width:"18px"}),b.find("[value='"+c+"']").css({border:"solid 1px #19a6a4",height:"20px",width:"20px"}),$(".edit-note-rect").css({padding:"0px","margin-top":"-43px","margin-left":"99px"})},b.prototype.unShareAnnotation=function(){this.annotation.color=this.annotation.lastColor,"#FFD232"==this.annotation.color?annBgColor="rgba(255,210,50,0.4)":"#55DF49"==this.annotation.color?annBgColor="#bbf2b6":"#FC92CF"==this.annotation.color&&(annBgColor="#fed3ec"),this.annotation.shareable=!1,$(this.annotation.highlights).css("background",annBgColor),$(".annotator-color").removeClass("active"),$('.annotator-color[value="'+this.annotation.color+'"]').addClass("active"),$(".annotator-color-container").removeClass("disabled-save"),$(this.annotation.highlights).removeClass("sharedNote")},b.prototype.onShareClick=function(a){var b=this;this.fromOnShare=!0,$(a.target).hasClass("on")?($(a.target).removeClass("on"),this.unShareAnnotation()):($(a.target).addClass("on"),this.annotation.color="#ccf5fd",this.annotation.shareable=!0,$(".annotator-color").removeClass("active"),$(this.annotation.highlights).css("background","#ccf5fd"),$(this.annotation.highlights).addClass("sharedNote"),$(".annotator-color-container").addClass("disabled-save")),setTimeout(function(){b.submit()},800)},b.prototype.onDeleteClick=function(a){this.element.addClass(this.classes.hide);var b=this.element.find(".annotator-panel-1"),c=this.element.find(".annotator-panel-2"),d=this.element.find(".annotator-panel-3"),e=this.element.find(".annotator-panel-4");return b.removeClass("hide-popup"),c.removeClass("overlay"),d.removeClass("overlay"),e.remove(),this.element.addClass("hide-note"),$(".annotator-outer.annotator-viewer").triggerHandler.apply($(".annotator-outer.annotator-viewer"),["delete",[this.annotation]])},b.prototype.onDeleteIconClick=function(a){$(a.target).hide(),$(".ann-cancel-delete-confirm-section").removeClass("hide").css({display:"block"})},b.prototype.onCancelClick=function(a){var b=this.element.find(".annotator-panel-1"),c=this.element.find(".annotator-panel-2"),d=this.element.find(".annotator-panel-3"),e=this.element.find(".annotator-panel-4");b.removeClass("hide-popup"),c.removeClass("overlay"),d.removeClass("overlay"),e.remove(),$(".ann-cancel-delete-confirm-section").hide(),$(".annotator-delete-container").show(),$(c).find("textarea").removeAttr("readonly")},b.prototype.onEditClick=function(a){this.element.addClass("show-edit-options"),$(this.element).find("textarea").show(),$(this.element).find("#noteContainer").hide(),this.element.find("textarea").css({"pointer-events":"all",opacity:"1","min-height":"40px"}),this.element.find("input").css({"pointer-events":"all",opacity:"1"}),$(this.element).find(".annotator-color-container").removeClass("disabled-save")},b.prototype.onNoteChange=function(a){this.element.addClass("show-edit-options"),a.target.value.length||$(this.element).find(".annotator-share-text, .annotator-share").hide();var b=a.currentTarget.value.length,c=this.const.characters,d=c-b;this.element.find("#letter-count").text(d>0&&d<51?"-"+d:d),$(".characters-left").css("display",d<51?"block":"none");var e=this.element.find(".annotator-item textarea"),f=e.height();if(this.textareaHeight=$("#annotator-field-"+this.randomId)[0].scrollHeight,f!==this.textareaHeight){var g=$(".annotator-editor").css("top");this.element.css({top:g})}},b.prototype.onColorChange=function(a){window.getSelection().removeAllRanges(),this.element.removeClass("hide-note");var b=$(".annotator-editor").hasClass("overlapingpopup"),c=!this.annotation.color;if(window.currAnn&&("block"==$("#noteContainer").css("display")?$(".annotator-edit-container").show():$(".annotator-edit-container").hide(),$(".annotator-outer.annotator-viewer").triggerHandler.apply($(".annotator-outer.annotator-viewer"),["delete",[window.currAnn]])),void 0===this.annotation._id&&null!==this.currentAnnotation){var d=this.currentAnnotation;Object.assign(this.annotation,d)}var e=a.getAttribute("value");this.annotation.color=this.annotation.lastColor=e,$(this.annotation.highlights).closest(".pxereaderSearchHighlight").length>0&&($(this.annotation.highlights).unwrap(".pxereaderSearchHighlight"),$(this.annotation.highlights).parents().removeClass("pxereaderSearchHighlight"),$(this.annotation.highlights).find(".annotator-handle").css("background-color","inherit"));var f="",g="",h="";if("#FFD232"==e?(f="rgba(255,210,50,0.4)",g="#ffedad",h="Q"):"#55DF49"==e?(f=g="#bbf2b6",h="M"):"#FC92CF"==e?(f=g="#fed3ec",h="O"):"#ccf5fd"==e?(f=g="#ccf5fd",h="I"):f=g=e,$(this.annotation.highlights).each(function(){"true"==$(this).parent().attr("shareable")?$(this).css("background","inherit"):$(this).css("background",f)}),$(this.annotation.highlights).find(".annotator-handle").text(h).css("background-color",g),c){var i=this.element.position().top+this.element.find("form").height()-this.element.find(".annotator-panel-1").height()-20;this.element.css({top:i})}this.annotation.shareable&&($(".annotator-share").removeClass("on"),this.unShareAnnotation()),b&&($("#noteContainer").css("display","none"),$("#annotator-field-0").css({display:"inline-block","pointer-events":"all",opacity:"1"}),$(".annotator-edit-container").hide()),setTimeout(function(){$("#annotator-field-0").focus()})},b.prototype.show=function(a,b){if(Annotator.Util.preventEventDefault(a),this.element.removeClass(this.classes.hide),$(this.annotation.highlights).removeClass("current-annotation"),this.annotation.text&&this.annotation.text.length||$(".annotator-edit-container").hide(),this.annotation.color=this.annotation.color||"",this.annotation.shareable=void 0!==this.annotation.shareable&&this.annotation.shareable,this.annotation.color||this.annotation.shareable){this.element.removeClass("hide-note");var c,d,e=this.element.find("textarea").prop("offsetHeight")||40;d=this.element.find("textarea").height(),this.element.find("textarea").height(e),c=this.element.position().top,0===this.element.find("textarea").val().length&&(e-=$(this.element).find("#noteContainer").height()),"none"!==this.element.find("#mathTitle").css("display")&&(c+=27),pos=e-d+c,this.element.css({top:pos})}return this.annotation.shareable?($(".annotator-share").addClass("on"),$(".annotator-color-container").addClass("disabled-save"),this.isShareable||$(".annotator-panel-1").addClass("disabled-save")):($(".annotator-share").removeClass("on"),$(".annotator-color-container").removeClass("disabled-save")),$(".annotator-select-inner-circle").hide(),$(".annotator-select-outer-circle").removeClass("circleborder"),this.annotation.id&&!$.trim(this.annotation.text).length?this.element.find(".annotator-widget").addClass("emptyNote"):this.element.find(".annotator-widget").removeClass("emptyNote"),this.annotation.color?($(".annotator-color-select-container").hide(),$(".edit-Note-Panel-1").show(),$(".annotator-panel-1").css({height:"62px",position:"initial"}),$(".edit-Note-Panel-1 .annotator-select-rect").hide(),$(".edit-Note-Panel-1 .edit-note-circle").hide(),$(".edit-Note-Panel-1").find("[value="+this.annotation.color+"]").show(),$(".edit-note-rect").css({padding:"20px","margin-top":"0px","margin-left":"0px"}),$(".ann-cancel-delete-confirm-section").hide(),$(".annotator-delete-container").show(),$(".annotator-panel-1").addClass("oldAnnotation"),"#ccf5fd"==this.annotation.color?(this.element.find(".annotator-widget").addClass("instructorNote"),$("#noteContainer").css("pointer-events","none"),$(".annotator-controls").hide(),$(".annotator-editor").css({top:b+$(".annotator-panel-1").height()+$(".annotator-panel-2 textarea").outerHeight(!0)})):(this.element.find(".annotator-widget").removeClass("instructorNote"),$("#noteContainer").css("pointer-events","all"),$(".annotator-controls").show(),$(".annotator-editor").css({top:b+$(".annotator-panel-1").height()+$(".annotator-panel-2 textarea").outerHeight(!0)+$(".annotator-controls").height()}))):($(".edit-Note-Panel-1").hide(),$(".annotator-color-select-container").show(),$(".annotator-panel-1").css({height:"110px",position:"relative"}),$(".annotator-panel-1").removeClass("oldAnnotation"),$(".annotator-editor").css({top:$(".annotator-editor").position().top+$(".annotator-panel-1").height()})),this.element.find(".annotator-save").addClass(this.classes.focus),this.element.find(".annotator-listing .characters-left").remove(),this.element.find(".annotator-listing").append(f),$("#letter-count").text(3e3-this.element.find("textarea").val().length),this.checkOrientation(),this.textareaHeight=$("#annotator-field-"+this.randomId)[0].scrollHeight||22,$.trim(this.annotation.text)&&$.trim(this.annotation.text).length||(this.element.find("textarea").css({"pointer-events":"all",opacity:"1"}),this.element.find("input").css({"pointer-events":"all",opacity:"1"})),this.element.find(":input:first").focus(),this.setupDraggables(),$.trim(this.element.find("textarea").val()).length>0&&this.annotation.color?($(this.element).find("#noteContainer").html(linkifyStr(this.element.find("textarea").val())),$(this.element.find("textarea")).hide(),$(this.element).find("#noteContainer").show()):($(this.element.find("textarea")).show(),$(this.element).find("#noteContainer").hide()),$(".annotator-panel-triangle1").addClass("annotator-panel-triangle").removeClass("annotator-panel-triangle1"),this.publish("show")},b.prototype.hide=function(a){var b,c="",d="",e="";"#FFD232"==this.annotation.color?(c="rgba(255,210,50,0.4)",d="#ffedad",e="Q"):"#55DF49"==this.annotation.color?(c=d="bbf2b6",e="M"):"#FC92CF"==this.annotation.color?(c=d="#fed3ec",e="O"):"#ccf5fd"==this.annotation.color?(c=d="#ccf5fd",e="I"):c=d=this.annotation.color;var f=$(".annotator-panel-2").find("textarea").val();this.annotation.text=f;var g=($.trim(this.annotation.text),$(this.annotation.highlights));for(b=0;b<g.length&&!($(g[b]).find(".annotator-handle").length>0);b++);return b==g.length&&$(g[0]).prepend("<span class='annotator-handle'></span>"),$(this.annotation.highlights).each(function(){"true"==$(this).parent().attr("shareable")?$(this).css("background","inherit").addClass("highlight-note"):$(this).css("background",c).addClass("highlight-note")}),$(this.annotation.highlights).find(".annotator-handle").each(function(a){0==a&&$(this).text(e).css("background-color",d)}),Annotator.Util.preventEventDefault(a),this.element.addClass(this.classes.hide),this.element.addClass("hide-note").removeClass("show-edit-options"),$(".annotator-edit-container").show(),$(".annotator-panel-1").removeClass("disabled-save"),this.onCancelClick(),this.element.find("textarea").removeAttr("style"),this.element.find("input").removeAttr("style"),this.currentAnnotation=this.textareaHeight=null,this.annotation.color&&this.annotation.color.length&&this.publish("save",[this.annotation]),this.publish("hide")},b.prototype.hasClass=function(a,b){do{if(a.classList&&a.classList.contains(b))return!0;a=a.parentNode}while(a);return!1},b.prototype.load=function(a,b,d,e){this.isShareable=b,b&&(!a||a.id&&a.text)?$(".annotator-share-text, .annotator-share").show():$(".annotator-share-text, .annotator-share").hide(),$(".annotator-item input").length||$(".annotator-item").prepend('<input placeholder="'+locale_data[c].addtitle+'." id = "mathTitle"/><div class="noteContainer" id = "noteContainer" ></div>'),$(".annotator-item input").val(a.quote),this.hasClass(a.highlights[0],"MathJax")?($(".annotator-item input").show(),a.id||(a.quote="",$(".annotator-item input").val(""))):$(".annotator-item input").hide();var f,g,h,i;for(this.annotation=a,this.publish("load",[this.annotation]),i=this.fields,g=0,h=i.length;g<h;g++)f=i[g],f.load(f.element,this.annotation);return this.show(e,d)},b.prototype.submit=function(a){var b,c,d,e,f;Annotator.Util.preventEventDefault(a),this.fromOnShare&&(this.fromOnShare=!1),this.annotation.quote=$(".annotator-item input").val();var g=$("#annotator-field-0").val();for(this.annotation.shareable&&(g||this.unShareAnnotation()),e=this.fields,c=0,d=e.length;c<d;c++)b=e[c],b.submit(b.element,this.annotation);for(f=$(this.annotation.highlights),c=0;c<f.length&&!($(f[c]).find(".annotator-handle").length>0);c++);return c==f.length&&$(f[0]).prepend("<span class='annotator-handle'></span>"),$(this.annotation.highlights)[this.element.find("textarea").val().length?"addClass":"removeClass"]("highlight-note"),this.hide()},b.prototype.addField=function(a){var b,c,d;switch(this.randomId=Annotator.Util.uuid(),c=$.extend({id:"annotator-field-"+this.randomId,type:"input",label:"",load:function(){},submit:function(){}},a),d=null,b=$('<li class="annotator-item" />'),c.element=b[0],c.type){case"textarea":d=$('<textarea maxlength="3000"/>');break;case"input":case"checkbox":d=$("<input />");break;case"select":d=$("<select />")}return b.append(d),d.attr({id:c.id,placeholder:c.label}),"checkbox"===c.type&&(d[0].type="checkbox",b.addClass("annotator-checkbox"),b.append($("<label />",{for:c.id,html:c.label}))),this.element.find("ul:first").append(b),this.fields.push(c),c.element},b.prototype.checkOrientation=function(){var a,c;return b.__super__.checkOrientation.apply(this,arguments),this.element.find("ul"),c=this.element.find(".annotator-panel-3"),a=this.element.find(".annotator-controls"),this.element.hasClass(this.classes.invert.y)?c.html(a):a.is(":first-child")&&c.html(a),this},b.prototype.processKeypress=function(a){if(27===a.keyCode)return this.hide();13!==a.keyCode||a.shiftKey||a.stopPropagation()},b.prototype.onCancelButtonMouseover=function(){return this.element.find("."+this.classes.focus).removeClass(this.classes.focus)},b.prototype.setupDraggables=function(){var a,b,c,d,e,f,g,h,i,j,k;return this.element.find(".annotator-resize").remove(),c=this.element.hasClass(this.classes.invert.y)?this.element.find(".annotator-item:last"):this.element.find(".annotator-item:first"),c&&$('<span class="annotator-resize"></span>').appendTo(c),e=null,a=this.classes,d=this.element,j=null,i=d.find(".annotator-resize"),b=d.find(".annotator-controls"),k=!1,f=function(a){if(a.target===this)return e={element:this,top:a.pageY,left:a.pageX},j=d.find("textarea:first"),$(window).bind({"mouseup.annotator-editor-resize":h,"mousemove.annotator-editor-resize":g}),a.preventDefault()},h=function(){return e=null,$(window).unbind(".annotator-editor-resize")},g=function(c){return function(c){var f,g,h,l,m;if(e&&!1===k)return f={top:c.pageY-e.top,left:c.pageX-e.left},e.element===i[0]?(l=j.height(),m=j.width(),g=d.hasClass(a.invert.x)?-1:1,h=d.hasClass(a.invert.y)?1:-1,j.height(l+f.top*h),j.width(m+f.left*g),j.height()!==l&&(e.top=c.pageY),j.width()!==m&&(e.left=c.pageX)):e.element===b[0]&&(d.css({top:parseInt(d.css("top"),10)+f.top,left:parseInt(d.css("left"),10)+f.left}),e.top=c.pageY,e.left=c.pageX),k=!0,setTimeout(function(){return k=!1},1e3/60)}}(),i.bind("mousedown",f),b.bind("mousedown",f)},b}(Annotator.Widget);var LinkParser,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Viewer=function(a){function b(a){this.onDeleteClick=__bind(this.onDeleteClick,this),this.onEditClick=__bind(this.onEditClick,this),this.load=__bind(this.load,this),this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),b.__super__.constructor.call(this,$(this.html.element)[0],a),this.item=$(this.html.item)[0],this.fields=[],this.annotations=[]}return __extends(b,a),b.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"},b.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"},b.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <a href="#" title="View as webpage" class="annotator-link">View as webpage</a>\n    <button title="Edit" class="annotator-edit">Edit</button>\n    <button title="Delete" class="annotator-delete">Delete</button>\n  </span>\n</li>'},b.prototype.options={readOnly:!1},b.prototype.show=function(a){var b;return Annotator.Util.preventEventDefault(a),b=this.element.find(".annotator-controls").addClass(this.classes.showControls),setTimeout(function(a){return function(){return b.removeClass(a.classes.showControls)}}(this),500),this.element.removeClass(this.classes.hide),this.checkOrientation().publish("show")},b.prototype.isShown=function(){return!this.element.hasClass(this.classes.hide)},b.prototype.hide=function(a){return Annotator.Util.preventEventDefault(a),this.element.addClass(this.classes.hide),this.publish("hide")},b.prototype.load=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;for(this.annotations=a||[],l=this.element.find("ul:first").empty(),q=this.annotations,m=0,o=q.length;m<o;m++)for(b=q[m],i=$(this.item).clone().appendTo(l).data("annotation",b),d=i.find(".annotator-controls"),j=d.find(".annotator-link"),f=d.find(".annotator-edit"),e=d.find(".annotator-delete"),k=new LinkParser(b.links||[]).get("alternate",{type:"text/html"}),0===k.length||null==k[0].href?j.remove():j.attr("href",k[0].href),this.options.readOnly?(f.remove(),e.remove()):c={showEdit:function(){return f.removeAttr("disabled")},hideEdit:function(){return f.attr("disabled","disabled")},showDelete:function(){return e.removeAttr("disabled")},hideDelete:function(){return e.attr("disabled","disabled")}},r=this.fields,n=0,p=r.length;n<p;n++)h=r[n],g=$(h.element).clone().appendTo(i)[0],h.load(g,b,c);return this.publish("load",[this.annotations]),this.show()},b.prototype.addField=function(a){var b;return b=$.extend({load:function(){}},a),b.element=$("<div />")[0],this.fields.push(b),b.element,this},b.prototype.onEditClick=function(a){return this.onButtonClick(a,"edit")},b.prototype.onDeleteClick=function(a){return this.onButtonClick(a,"delete")},b.prototype.onButtonClick=function(a,b){var c;return c=$(a.target).parents(".annotator-annotation"),this.publish(b,[c.data("annotation")])},b}(Annotator.Widget),LinkParser=function(){function a(a){this.data=a}return a.prototype.get=function(a,b){var c,d,e,f,g,h,i,j;for(null==b&&(b={}),b=$.extend({},b,{rel:a}),e=function(){var a;a=[];for(d in b)__hasProp.call(b,d)&&(f=b[d],a.push(d));return a}(),i=this.data,j=[],g=0,h=i.length;g<h;g++)c=i[g],e.reduce(function(a,d){return a&&c[d]===b[d]},!0)&&j.push(c);return j},a}();var Annotator,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator=Annotator||{},Annotator.Notification=function(a){function b(a){this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),b.__super__.constructor.call(this,$(this.options.html).appendTo(document.body)[0],a)}return __extends(b,a),b.prototype.events={click:"hide"},b.prototype.options={html:"<div class='annotator-notice'></div>",classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}},b.prototype.show=function(a,b){return null==b&&(b=Annotator.Notification.INFO),this.currentStatus=b,$(this.element).addClass(this.options.classes.show).addClass(this.options.classes[this.currentStatus]).html(Util.escape(a||"")),setTimeout(this.hide,5e3),this},b.prototype.hide=function(){return null==this.currentStatus&&(this.currentStatus=Annotator.Notification.INFO),$(this.element).removeClass(this.options.classes.show).removeClass(this.options.classes[this.currentStatus]),this},b}(Delegator),Annotator.Notification.INFO="info",Annotator.Notification.SUCCESS="success",Annotator.Notification.ERROR="error",$(function(){var a;return a=new Annotator.Notification,Annotator.showNotification=a.show,Annotator.hideNotification=a.hide});var findChild,getNodeName,getNodePosition,simpleXPathJQuery,simpleXPathPure;simpleXPathJQuery=function(a){var b;return b=this.map(function(){var b,c,d,e;for(d="",b=this;(null!=b?b.nodeType:void 0)===Node.ELEMENT_NODE&&b!==a;)e=b.tagName.replace(":","\\:"),c=$(b.parentNode).children(e).index(b)+1,c="["+c+"]",d="/"+b.tagName.toLowerCase()+c+d,b=b.parentNode;return d}),b.get()},simpleXPathPure=function(a){var b,c,d,e;return b=function(a){var b,c;return b=getNodeName(a),c=getNodePosition(a),b+"["+c+"]"},e=a,c=function(a){var c;for(c="";a!==e;){if(null==a)throw new Error("Called getPathTo on a node which was not a descendant of @rootNode. "+e);c=b(a)+"/"+c,a=a.parentNode}return c="/"+c,c=c.replace(/\/$/,"")},d=this.map(function(){return c(this)}),d.get()},findChild=function(a,b,c){var d,e,f,g,h;if(!a.hasChildNodes())throw new Error("XPath error: node has no children!");for(e=a.childNodes,f=0,g=0,h=e.length;g<h;g++)if(d=e[g],getNodeName(d)===b&&(f+=1)===c)return d;throw new Error("XPath error: wanted child not found.")},getNodeName=function(a){var b;switch(b=a.nodeName.toLowerCase()){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return b}},getNodePosition=function(a){var b,c;for(b=0,c=a;c;)c.nodeName===a.nodeName&&b++,c=c.previousSibling;return b};var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},__indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};Annotator.Plugin.Store=function(a){function b(a,c){this._onError=__bind(this._onError,this),this._onLoadAnnotationsFromSearch=__bind(this._onLoadAnnotationsFromSearch,this),this._onLoadAnnotations=__bind(this._onLoadAnnotations,this),this._getAnnotations=__bind(this._getAnnotations,this),b.__super__.constructor.apply(this,arguments),this.annotations=[]}return __extends(b,a),b.prototype.events={annotationCreated:"annotationCreated",annotationDeleted:"annotationDeleted",annotationUpdated:"annotationUpdated"},b.prototype.options={annotationData:{},emulateHTTP:!1,loadFromSearch:!1,prefix:"/store",urls:{create:"/annotations",read:"/annotations/:id",update:"/annotations/:id",destroy:"/annotations/:id",search:"/search"}},b.prototype.pluginInit=function(){if(Annotator.supported())return this.annotator.plugins.Auth?this.annotator.plugins.Auth.withToken(this._getAnnotations):this._getAnnotations()},b.prototype._getAnnotations=function(){return this.options.loadFromSearch?this.loadAnnotationsFromSearch(this.options.loadFromSearch):this.loadAnnotations()},b.prototype.annotationCreated=function(a){return __indexOf.call(this.annotations,a)<0?(this.registerAnnotation(a),this._apiRequest("create",a,function(b){return function(c){return null==c.id&&console.warn(Annotator._t("Warning: No ID returned from server for annotation "),a),b.updateAnnotation(a,c)}}(this))):this.updateAnnotation(a,{})},b.prototype.annotationUpdated=function(a){if(__indexOf.call(this.annotations,a)>=0)return this._apiRequest("update",a,function(b){return function(c){return b.updateAnnotation(a,c)}}(this))},b.prototype.annotationDeleted=function(a){if(__indexOf.call(this.annotations,a)>=0)return this._apiRequest("destroy",a,function(b){return function(){return b.unregisterAnnotation(a)}}(this))},b.prototype.registerAnnotation=function(a){return this.annotations.push(a)},b.prototype.unregisterAnnotation=function(a){return this.annotations.splice(this.annotations.indexOf(a),1)},b.prototype.updateAnnotation=function(a,b){return __indexOf.call(this.annotations,a)<0?console.error(Annotator._t("Trying to update unregistered annotation!")):$.extend(a,b),$(a.highlights).data("annotation",a)},b.prototype.loadAnnotations=function(){return this._apiRequest("read",null,this._onLoadAnnotations)},b.prototype._onLoadAnnotations=function(a){var b,c,d,e,f,g,h,i,j;for(null==a&&(a=[]),d={},j=this.annotations,f=0,h=j.length;f<h;f++)b=j[f],d[b.id]=b;for(e=[],g=0,i=a.length;g<i;g++)b=a[g],d[b.id]?(c=d[b.id],this.updateAnnotation(c,b)):e.push(b);return this.annotations=this.annotations.concat(e),this.annotator.loadAnnotations(e.slice())},b.prototype.loadAnnotationsFromSearch=function(a){return this._apiRequest("search",a,this._onLoadAnnotationsFromSearch)},b.prototype._onLoadAnnotationsFromSearch=function(a){return null==a&&(a={}),this._onLoadAnnotations(a.rows||[])},b.prototype.dumpAnnotations=function(){var a,b,c,d,e;for(d=this.annotations,e=[],b=0,c=d.length;b<c;b++)a=d[b],e.push(JSON.parse(this._dataFor(a)));return e},b.prototype._apiRequest=function(a,b,c){var d,e,f,g;return d=b&&b.id,g=this._urlFor(a,d),e=this._apiRequestOptions(a,b,c),f=$.ajax(g,e),f._id=d,f._action=a,f},b.prototype._apiRequestOptions=function(a,b,c){var d,e,f;return e=this._methodFor(a),f={type:e,headers:this.element.data("annotator:headers"),dataType:"json",success:c||function(){},error:this._onError},!this.options.emulateHTTP||"PUT"!==e&&"DELETE"!==e||(f.headers=$.extend(f.headers,{"X-HTTP-Method-Override":e}),f.type="POST"),"search"===a?f=$.extend(f,{data:b}):(d=b&&this._dataFor(b),this.options.emulateJSON?(f.data={json:d},this.options.emulateHTTP&&(f.data._method=e),f):f=$.extend(f,{data:d,contentType:"application/json; charset=utf-8"}))},b.prototype._urlFor=function(a,b){var c;return c=null!=this.options.prefix?this.options.prefix:"",c+=this.options.urls[a],c=c.replace(/\/:id/,null!=b?"/"+b:""),c=c.replace(/:id/,null!=b?b:"")},b.prototype._methodFor=function(a){var b;return b={create:"POST",read:"GET",update:"PUT",destroy:"DELETE",search:"GET"},b[a]},b.prototype._dataFor=function(a){var b,c;return c=a.highlights,delete a.highlights,$.extend(a,this.options.annotationData),b=JSON.stringify(a),c&&(a.highlights=c),b},b.prototype._onError=function(a){var b,c;switch(b=a._action,c=Annotator._t("Sorry we could not ")+b+Annotator._t(" this annotation"),"search"===a._action?c=Annotator._t("Sorry we could not search the store for annotations"):"read"!==a._action||a._id||(c=Annotator._t("Sorry we could not ")+b+Annotator._t(" the annotations from the store")),a.status){case 401:c=Annotator._t("Sorry you are not allowed to ")+b+Annotator._t(" this annotation");break;case 404:c=Annotator._t("Sorry we could not connect to the annotations store");break;case 500:c=Annotator._t("Sorry something went wrong with the annotation store")}return Annotator.showNotification(c,Annotator.Notification.ERROR),console.error(Annotator._t("API request failed:")+" '"+a.status+"'")},b}(Annotator.Plugin);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Plugin.Permissions=function(a){function b(a,c){this._setAuthFromToken=__bind(this._setAuthFromToken,this),this.updateViewer=__bind(this.updateViewer,this),this.updateAnnotationPermissions=__bind(this.updateAnnotationPermissions,this),this.updatePermissionsField=__bind(this.updatePermissionsField,this),this.addFieldsToAnnotation=__bind(this.addFieldsToAnnotation,this),b.__super__.constructor.apply(this,arguments),this.options.user&&(this.setUser(this.options.user),delete this.options.user)}return __extends(b,a),b.prototype.events={beforeAnnotationCreated:"addFieldsToAnnotation"},b.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,userId:function(a){return a},userString:function(a){return a},userAuthorize:function(a,b,c){var d,e,f,g;if(b.permissions){if(e=b.permissions[a]||[],0===e.length)return!0;for(f=0,g=e.length;f<g;f++)if(d=e[f],this.userId(c)===d)return!0;return!1}return!b.user||!!c&&this.userId(c)===this.userId(b.user)},user:"",permissions:{read:[],update:[],delete:[],admin:[]}},b.prototype.pluginInit=function(){var a,b;if(Annotator.supported())return b=this,a=function(a,c){return function(d,e){return b[a].call(b,c,d,e)}},!this.user&&this.annotator.plugins.Auth&&this.annotator.plugins.Auth.withToken(this._setAuthFromToken),!0===this.options.showViewPermissionsCheckbox&&this.annotator.editor.addField({type:"checkbox",label:Annotator._t("Allow anyone to <strong>view</strong> this annotation"),load:a("updatePermissionsField","read"),submit:a("updateAnnotationPermissions","read")}),!0===this.options.showEditPermissionsCheckbox&&this.annotator.editor.addField({type:"checkbox",label:Annotator._t("Allow anyone to <strong>edit</strong> this annotation"),load:a("updatePermissionsField","update"),submit:a("updateAnnotationPermissions","update")}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter?this.annotator.plugins.Filter.addFilter({label:Annotator._t("User"),property:"user",isFiltered:function(a){return function(b,c){var d,e,f,g;if(c=a.options.userString(c),!b||!c)return!1;for(g=b.split(/\s*/),e=0,f=g.length;e<f;e++)if(d=g[e],-1===c.indexOf(d))return!1;return!0}}(this)}):void 0},b.prototype.setUser=function(a){return this.user=a},b.prototype.addFieldsToAnnotation=function(a){if(a&&(a.permissions=$.extend(!0,{},this.options.permissions),this.user))return a.user=this.user},b.prototype.authorize=function(a,b,c){return void 0===c&&(c=this.user),!this.options.userAuthorize||this.options.userAuthorize.call(this.options,a,b,c)},b.prototype.updatePermissionsField=function(a,b,c){var d;return b=$(b).show(),d=b.find("input").removeAttr("disabled"),this.authorize("admin",c)||b.hide(),this.authorize(a,c||{},null)?d.attr("checked","checked"):d.removeAttr("checked")},b.prototype.updateAnnotationPermissions=function(a,b,c){return c.permissions||(c.permissions=$.extend(!0,{},this.options.permissions)),a+"-permissions",$(b).find("input").is(":checked")?c.permissions[a]=[]:c.permissions[a]=[this.options.userId(this.user)]},b.prototype.updateViewer=function(a,b,c){var d,e;if(a=$(a),e=this.options.userString(b.user),b.user&&e&&"string"==typeof e?(d=Annotator.Util.escape(this.options.userString(b.user)),a.html(d).addClass("annotator-user")):a.remove(),c&&(this.authorize("update",b)||c.hideEdit(),!this.authorize("delete",b)))return c.hideDelete()},b.prototype._setAuthFromToken=function(a){return this.setUser(a.userId)},b}(Annotator.Plugin);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},__indexOf=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};Annotator.Plugin.AnnotateItPermissions=function(a){function b(){return this._setAuthFromToken=__bind(this._setAuthFromToken,this),this.updateAnnotationPermissions=__bind(this.updateAnnotationPermissions,this),this.updatePermissionsField=__bind(this.updatePermissionsField,this),this.addFieldsToAnnotation=__bind(this.addFieldsToAnnotation,this),b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,groups:{world:"group:__world__",authenticated:"group:__authenticated__",consumer:"group:__consumer__"},userId:function(a){return a.userId},userString:function(a){return a.userId},userAuthorize:function(a,b,c){var d,e,f,g,h,i;return e=b.permissions||{},d=e[a]||[],f=this.groups.world,__indexOf.call(d,f)>=0||null!=c&&null!=c.userId&&null!=c.consumerKey&&(c.userId===b.user&&c.consumerKey===b.consumer||(g=this.groups.authenticated,__indexOf.call(d,g)>=0||(c.consumerKey===b.consumer&&(h=this.groups.consumer,__indexOf.call(d,h)>=0)||(c.consumerKey===b.consumer&&(i=c.userId,__indexOf.call(d,i)>=0)||!(c.consumerKey!==b.consumer||!c.admin)))))},permissions:{read:["group:__world__"],update:[],delete:[],admin:[]}},b.prototype.addFieldsToAnnotation=function(a){if(a&&(a.permissions=this.options.permissions,this.user))return a.user=this.user.userId,a.consumer=this.user.consumerKey},b.prototype.updatePermissionsField=function(a,b,c){var d;return b=$(b).show(),d=b.find("input").removeAttr("disabled"),this.authorize("admin",c)||b.hide(),this.user&&this.authorize(a,c||{},{userId:"__nonexistentuser__",consumerKey:this.user.consumerKey})?d.attr("checked","checked"):d.removeAttr("checked")},b.prototype.updateAnnotationPermissions=function(a,b,c){return c.permissions||(c.permissions=this.options.permissions),a+"-permissions",$(b).find("input").is(":checked")?c.permissions[a]=["read"===a?this.options.groups.world:this.options.groups.consumer]:c.permissions[a]=[]},b.prototype._setAuthFromToken=function(a){return this.setUser(a)},b}(Annotator.Plugin.Permissions);var base64Decode,base64UrlDecode,createDateFromISO8601,parseToken,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};createDateFromISO8601=function(a){var b,c,d,e,f,g;return e="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\\.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?",b=a.match(new RegExp(e)),d=0,c=new Date(b[1],0,1),b[3]&&c.setMonth(b[3]-1),b[5]&&c.setDate(b[5]),b[7]&&c.setHours(b[7]),b[8]&&c.setMinutes(b[8]),b[10]&&c.setSeconds(b[10]),b[12]&&c.setMilliseconds(1e3*Number("0."+b[12])),b[14]&&(d=60*Number(b[16])+Number(b[17]),d*=null!=(g="-"===b[15])?g:{1:-1}),d-=c.getTimezoneOffset(),f=Number(c)+60*d*1e3,c.setTime(Number(f)),c},base64Decode=function(a){var b,c,d,e,f,g,h,i,j,k,l,m;if("undefined"!=typeof atob&&null!==atob)return atob(a);if(c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i=0,b=0,"",m=[],!a)return a;for(a+="";i<a.length;)e=c.indexOf(a.charAt(i++)),f=c.indexOf(a.charAt(i++)),g=c.indexOf(a.charAt(i++)),h=c.indexOf(a.charAt(i++)),d=e<<18|f<<12|g<<6|h,j=d>>16&255,k=d>>8&255,l=255&d,m[b++]=64===g?String.fromCharCode(j):64===h?String.fromCharCode(j,k):String.fromCharCode(j,k,l);return m.join("")},base64UrlDecode=function(a){var b,c,d;if(0!==(b=a.length%4))for(c=0,d=4-b;0<=d?c<d:c>d;0<=d?++c:--c)a+="=";return a=a.replace(/-/g,"+"),a=a.replace(/_/g,"/"),base64Decode(a)},parseToken=function(a){var b,c;return c=a.split("."),c[0],b=c[1],c[2],JSON.parse(base64UrlDecode(b))},Annotator.Plugin.Auth=function(a){function b(a,c){b.__super__.constructor.apply(this,arguments),this.waitingForToken=[],this.options.token?this.setToken(this.options.token):this.requestToken()}return __extends(b,a),b.prototype.options={token:null,tokenUrl:"/auth/token",autoFetch:!0},b.prototype.requestToken=function(){return this.requestInProgress=!0,$.ajax({url:this.options.tokenUrl,dataType:"text",xhrFields:{withCredentials:!0}}).done(function(a){return function(b,c,d){return a.setToken(b)}}(this)).fail(function(a){return function(a,b,c){var d;return d=Annotator._t("Couldn't get auth token:"),console.error(d+" "+c,a),Annotator.showNotification(d+" "+a.responseText,Annotator.Notification.ERROR)}}()).always(function(a){return function(){return a.requestInProgress=!1}}(this))},b.prototype.setToken=function(a){var b;if(this.token=a,this._unsafeToken=parseToken(a),this.haveValidToken()){for(this.options.autoFetch&&(this.refreshTimeout=setTimeout(function(a){return function(){return a.requestToken()}}(this),1e3*(this.timeToExpiry()-2))),this.updateHeaders(),b=[];this.waitingForToken.length>0;)b.push(this.waitingForToken.pop()(this._unsafeToken));return b}if(console.warn(Annotator._t("Didn't get a valid token.")),this.options.autoFetch)return console.warn(Annotator._t("Getting a new token in 10s.")),setTimeout(function(a){return function(){return a.requestToken()}}(this),1e4)},b.prototype.haveValidToken=function(){return!!(this._unsafeToken&&this._unsafeToken.issuedAt&&this._unsafeToken.ttl&&this._unsafeToken.consumerKey&&this.timeToExpiry()>0)},b.prototype.timeToExpiry=function(){var a,b,c,d;return c=(new Date).getTime()/1e3,b=createDateFromISO8601(this._unsafeToken.issuedAt).getTime()/1e3,a=b+this._unsafeToken.ttl,d=a-c,d>0?d:0},b.prototype.updateHeaders=function(){var a;return a=this.element.data("annotator:headers"),this.element.data("annotator:headers",$.extend(a,{"x-annotator-auth-token":this.token}))},b.prototype.withToken=function(a){if(null!=a)return this.haveValidToken()?a(this._unsafeToken):(this.waitingForToken.push(a),this.requestInProgress?void 0:this.requestToken())},b}(Annotator.Plugin);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Plugin.Tags=function(a){function b(){return this.setAnnotationTags=__bind(this.setAnnotationTags,this),this.updateField=__bind(this.updateField,this),b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.options={parseTags:function(a){var b;return a=$.trim(a),b=[],a&&(b=a.split(/\s+/)),b},stringifyTags:function(a){return a.join(" ")}},b.prototype.field=null,b.prototype.input=null,b.prototype.pluginInit=function(){if(Annotator.supported())return this.field=this.annotator.editor.addField({label:Annotator._t("Add some tags here")+"…",load:this.updateField,submit:this.setAnnotationTags}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter&&this.annotator.plugins.Filter.addFilter({label:Annotator._t("Tag"),property:"tags",isFiltered:Annotator.Plugin.Tags.filterCallback}),this.input=$(this.field).find(":input")},b.prototype.parseTags=function(a){return this.options.parseTags(a)},b.prototype.stringifyTags=function(a){return this.options.stringifyTags(a)},b.prototype.updateField=function(a,b){var c;return c="",b.tags&&(c=this.stringifyTags(b.tags)),this.input.val(c)},b.prototype.setAnnotationTags=function(a,b){return b.tags=this.parseTags(this.input.val())},b.prototype.updateViewer=function(a,b){return a=$(a),b.tags&&$.isArray(b.tags)&&b.tags.length?a.addClass("annotator-tags").html(function(){return $.map(b.tags,function(a){return'<span class="annotator-tag">'+Annotator.Util.escape(a)+"</span>"}).join(" ")}):a.remove()},b}(Annotator.Plugin),Annotator.Plugin.Tags.filterCallback=function(a,b){var c,d,e,f,g,h,i,j;if(null==b&&(b=[]),e=0,d=[],a)for(d=a.split(/\s+/g),g=0,i=d.length;g<i;g++)if(c=d[g],b.length)for(h=0,j=b.length;h<j;h++)f=b[h],-1!==f.indexOf(c)&&(e+=1);return e===d.length};var __hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Plugin.Unsupported=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.options={message:Annotator._t("Sorry your current browser does not support the Annotator")},b.prototype.pluginInit=function(){if(!Annotator.supported())return $(function(a){return function(){if(Annotator.showNotification(a.options.message),void 0===window.XMLHttpRequest&&void 0!==ActiveXObject)return $("html").addClass("ie6")}}(this))},b}(Annotator.Plugin);var __bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};Annotator.Plugin.Filter=function(a){function b(a,c){this._onPreviousClick=__bind(this._onPreviousClick,this),this._onNextClick=__bind(this._onNextClick,this),this._onFilterKeyup=__bind(this._onFilterKeyup,this),this._onFilterBlur=__bind(this._onFilterBlur,this),this._onFilterFocus=__bind(this._onFilterFocus,this),this.updateHighlights=__bind(this.updateHighlights,this);var d;a=$(this.html.element).appendTo((null!=c?c.appendTo:void 0)||this.options.appendTo),b.__super__.constructor.call(this,a,c),(d=this.options).filters||(d.filters=[]),this.filter=$(this.html.filter),this.filters=[],this.current=0}return __extends(b,a),b.prototype.events={".annotator-filter-property input focus":"_onFilterFocus",".annotator-filter-property input blur":"_onFilterBlur",".annotator-filter-property input keyup":"_onFilterKeyup",".annotator-filter-previous click":"_onPreviousClick",".annotator-filter-next click":"_onNextClick",".annotator-filter-clear click":"_onClearClick"},b.prototype.classes={active:"annotator-filter-active",hl:{hide:"annotator-hl-filtered",active:"annotator-hl-active"}},b.prototype.html={element:'<div class="annotator-filter">\n  <strong>'+Annotator._t("Navigate:")+'</strong>\n<span class="annotator-filter-navigation">\n  <button class="annotator-filter-previous">'+Annotator._t("Previous")+'</button>\n<button class="annotator-filter-next">'+Annotator._t("Next")+"</button>\n</span>\n<strong>"+Annotator._t("Filter by:")+"</strong>\n</div>",filter:'<span class="annotator-filter-property">\n  <label></label>\n  <input/>\n  <button class="annotator-filter-clear">'+Annotator._t("Clear")+"</button>\n</span>"},b.prototype.options={appendTo:"body",filters:[],addAnnotationFilter:!0,isFiltered:function(a,b){var c,d,e,f;if(!a||!b)return!1;for(f=a.split(/\s+/),d=0,e=f.length;d<e;d++)if(c=f[d],-1===b.indexOf(c))return!1;return!0}},b.prototype.pluginInit=function(){var a,b,c,d;for(d=this.options.filters,b=0,c=d.length;b<c;b++)a=d[b],this.addFilter(a);if(this.updateHighlights(),this._setupListeners()._insertSpacer(),!0===this.options.addAnnotationFilter)return this.addFilter({label:Annotator._t("Annotation"),property:"text"})},b.prototype.destroy=function(){var a,c;return b.__super__.destroy.apply(this,arguments),c=$("html"),a=parseInt(c.css("padding-top"),10)||0,c.css("padding-top",a-this.element.outerHeight()),this.element.remove()},b.prototype._insertSpacer=function(){var a,b;return b=$("html"),a=parseInt(b.css("padding-top"),10)||0,b.css("padding-top",a+this.element.outerHeight()),this},b.prototype._setupListeners=function(){var a,b,c,d;for(b=["annotationsLoaded","annotationCreated","annotationUpdated","annotationDeleted"],c=0,d=b.length;c<d;c++)a=b[c],this.annotator.subscribe(a,this.updateHighlights);return this},b.prototype.addFilter=function(a){var b,c;return c=$.extend({label:"",property:"",isFiltered:this.options.isFiltered},a),function(){var a,d,e,f;for(e=this.filters,f=[],a=0,d=e.length;a<d;a++)b=e[a],b.property===c.property&&f.push(b);return f}.call(this).length||(c.id="annotator-filter-"+c.property,c.annotations=[],c.element=this.filter.clone().appendTo(this.element),c.element.find("label").html(c.label).attr("for",c.id),c.element.find("input").attr({id:c.id,placeholder:Annotator._t("Filter by ")+c.label+"…"}),c.element.find("button").hide(),c.element.data("filter",c),this.filters.push(c)),this},b.prototype.updateFilter=function(a){var b,c,d,e,f,g,h;if(a.annotations=[],this.updateHighlights(),this.resetHighlights(),d=$.trim(a.element.find("input").val())){for(c=this.highlights.map(function(){return $(this).data("annotation")}),h=$.makeArray(c),f=0,g=h.length;f<g;f++)b=h[f],e=b[a.property],a.isFiltered(d,e)&&a.annotations.push(b);return this.filterHighlights()}},b.prototype.updateHighlights=function(){return this.highlights=this.annotator.element.find(".annotator-hl:visible"),this.filtered=this.highlights.not(this.classes.hl.hide)},b.prototype.filterHighlights=function(){var a,b,c,d,e,f,g,h,i,j;for(a=$.grep(this.filters,function(a){return!!a.annotations.length}),d=(null!=(j=a[0])?j.annotations:void 0)||[],a.length>1&&(c=[],$.each(a,function(){return $.merge(c,this.annotations)}),g=[],d=[],$.each(c,function(){return-1===$.inArray(this,g)?g.push(this):d.push(this)})),e=this.highlights,f=h=0,i=d.length;h<i;f=++h)b=d[f],e=e.not(b.highlights);return e.addClass(this.classes.hl.hide),this.filtered=this.highlights.not(this.classes.hl.hide),this},b.prototype.resetHighlights=function(){return this.highlights.removeClass(this.classes.hl.hide),this.filtered=this.highlights,this},b.prototype._onFilterFocus=function(a){var b;return b=$(a.target),b.parent().addClass(this.classes.active),b.next("button").show()},b.prototype._onFilterBlur=function(a){var b;if(!a.target.value)return b=$(a.target),b.parent().removeClass(this.classes.active),b.next("button").hide()},b.prototype._onFilterKeyup=function(a){var b;if(b=$(a.target).parent().data("filter"))return this.updateFilter(b)},b.prototype._findNextHighlight=function(a){var b,c,d,e,f,g,h,i;return this.highlights.length?(g=a?0:-1,i=a?-1:0,h=a?"lt":"gt",b=this.highlights.not("."+this.classes.hl.hide),d=b.filter("."+this.classes.hl.active),d.length||(d=b.eq(g)),c=d.data("annotation"),e=b.index(d[0]),f=b.filter(":"+h+"("+e+")").not(c.highlights).eq(i),f.length||(f=b.eq(i)),this._scrollToHighlight(f.data("annotation").highlights)):this},b.prototype._onNextClick=function(a){return this._findNextHighlight()},b.prototype._onPreviousClick=function(a){return this._findNextHighlight(!0)},b.prototype._scrollToHighlight=function(a){return a=$(a),this.highlights.removeClass(this.classes.hl.active),a.addClass(this.classes.hl.active),$("html, body").animate({scrollTop:a.offset().top-(this.element.height()+20)},150)},b.prototype._onClearClick=function(a){return $(a.target).prev("input").val("").keyup().blur()},b}(Annotator.Plugin);